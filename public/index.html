<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>JHuan</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta property="og:type" content="website">
<meta property="og:title" content="JHuan">
<meta property="og:url" content="http://Jhuan.coding.me/JHuan/index.html">
<meta property="og:site_name" content="JHuan">
<meta property="og:locale" content="zh-CN">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="JHuan">
  
    <link rel="alternative" href="/atom.xml" title="JHuan" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="/css/style.css">
  

</head>
<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">JHuan</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">谈笑有鸿儒</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://Jhuan.coding.me/JHuan"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="hexo-挖VerticalViewPager+RecyclerView滑动冲突的祖坟！" class="article article-type-hexo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2018/01/03/cjgc9hck300006csob4ju9oft/" class="article-date">
  <time datetime="2018-01-03T13:21:22.000Z" itemprop="datePublished">2018-01-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2018/01/03/cjgc9hck300006csob4ju9oft/">挖VerticalViewPager+RecyclerView滑动冲突的祖坟！</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=default"></script>


<h1 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h1><p>某个阳光明媚到忧伤的午后，突然收到一个诡异的bug提醒，简单明了的写着<br><strong>弹幕区域无法滑动！</strong><br>一开始无法重现还以为是操作失误之类，后来发现的一个现象让人毛骨悚然:<br>为啥竖屏下弹幕区域的滑动如丝流畅但横屏下已经成为bug？是卢本伟写的代码么？<br><img src="https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5a4b79a06f0b932c360e8821" alt=""></p>
<h1 id="思考过程"><a href="#思考过程" class="headerlink" title="思考过程"></a>思考过程</h1><p>复盘这个查bug的过程，大致可分为<strong>定位问题范围</strong>，<strong>定位debug方向</strong>，<strong>关键节点断点调试</strong>，<strong>根据异常信息假设</strong>，<strong>根据正确的假设找根因</strong>。</p>
<h2 id="定位问题范围"><a href="#定位问题范围" class="headerlink" title="定位问题范围"></a>定位问题范围</h2><p>首先，上来先查看提交日志以及历史构建版本验证，看看是哪个小坏蛋提交的bug呢？一看傻眼，是新版本播放器进行重构时引入的bug，视图层级有了不小的变动：<br>1.重构前<br><img src="https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5a4b77f36f0b932c360e881e" alt=""></p>
<p>2.重构后<br><img src="https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5a4b78656f0b932c360e881f" alt=""></p>
<p><em>ps：这里为了简化问题背景聚焦bug本身，不过多详细描述需求背景，其变更以及实现方式选型，可以后续讨论。这里的VerticalViewpager名如其意，就是竖直方向的Viewpager。</em></p>
<p>虽然可以获知是Viewpager+RecyclerView的滑动冲突问题，但目前就只能止步于此，无法更进一步获知具体是哪行代码哪个文件改动产生的bug了。</p>
<h2 id="定位debug方向"><a href="#定位debug方向" class="headerlink" title="定位debug方向"></a>定位debug方向</h2><p>ok，目前我们知道了Viewpager+RecyclerView的滑动冲突问题，那么…..<br>并没有什么卵用妈蛋这个不查日志就知道了好么┴┴︵╰（‵□′）╯︵┴┴</p>
<p>冷静冷静，方向很关键，一时找不到方向时，先补充下基础知识开拓思路是很有效的。</p>
<h3 id="Viewgroup事件分发机制（简略版）"><a href="#Viewgroup事件分发机制（简略版）" class="headerlink" title="Viewgroup事件分发机制（简略版）"></a>Viewgroup事件分发机制（简略版）</h3><p>先简单过一遍基础的事件分发机制用到的方法，欲了解详情这里有个博文还不错，可以配合官方文档服用，<a href="https://www.jianshu.com/p/38015afcdb58" target="_blank" rel="noopener">Android事件分发机制详解</a>。</p>
<p>一般而言，我们接触的最多是这三个函数：</p>
<ul>
<li><strong>boolean dispatchTouchEvent (MotionEvent event)</strong><br>Pass the touch screen motion event down to the target view, or this view if it is the target.</li>
</ul>
<p><strong>Parameters</strong><br><em>event</em>    MotionEvent: The motion event to be dispatched.<br><strong>Returns</strong><br><em>boolean</em>    True if the event was handled by the view, false otherwise.</p>
<ul>
<li><strong>boolean onInterceptTouchEvent (MotionEvent ev)</strong><br>Implement this method to intercept all touch screen motion events. This allows you to watch events as they are dispatched to your children, and take ownership of the current gesture at any point.</li>
</ul>
<p><strong>Parameters</strong><br><em>ev</em>    MotionEvent: The motion event being dispatched down the hierarchy.<br><strong>Returns</strong><br><em>boolean</em>    Return true to steal motion events from the children and have them dispatched to this ViewGroup through onTouchEvent(). The current target will receive an ACTION_CANCEL event, and no further messages will be delivered here.</p>
<ul>
<li><strong>boolean onTouchEvent (MotionEvent event)</strong><br>Implement this method to handle touch screen motion events.</li>
</ul>
<p>If this method is used to detect click actions, it is recommended that the actions be performed by implementing and calling performClick(). This will ensure consistent system behavior, including:</p>
<p><strong>Parameters</strong><br><em>event</em>    MotionEvent: The motion event.<br><strong>Returns</strong><br><em>boolean</em>    True if the event was handled, false otherwise.</p>
<p>三者之间的关系可以用一段伪代码描述：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 点击事件产生后，会直接调用dispatchTouchEvent（）方法</span></span><br><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">boolean</span> <span class="title">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//代表是否消耗事件</span></span><br><span class="line">    <span class="keyword">boolean</span> consume = <span class="keyword">false</span>;</span><br><span class="line">  </span><br><span class="line">    </span><br><span class="line">    <span class="keyword">if</span> (onInterceptTouchEvent(ev)) &#123;</span><br><span class="line">    <span class="comment">//如果onInterceptTouchEvent()返回true则代表当前View拦截了点击事件</span></span><br><span class="line">    <span class="comment">//则该点击事件则会交给当前View进行处理</span></span><br><span class="line">    <span class="comment">//即调用onTouchEvent (）方法去处理点击事件</span></span><br><span class="line">      consume = onTouchEvent (ev) ;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">//如果onInterceptTouchEvent()返回false则代表当前View不拦截点击事件</span></span><br><span class="line">      <span class="comment">//则该点击事件则会继续传递给它的子元素</span></span><br><span class="line">      <span class="comment">//子元素的dispatchTouchEvent（）就会被调用，重复上述过程</span></span><br><span class="line">      <span class="comment">//直到点击事件被最终处理为止</span></span><br><span class="line">      consume = child.dispatchTouchEvent (ev) ;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> consume;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure></p>
<p>ok，这里我们知道了父ViewGroup最先收到事件并判断是否要拦截事件，如果拦截下来了，由父ViewGroup消耗这个事件，子view就压根收不到事件了。<br>那么就有同学要问了，那么子view是不是就没有翻身的机会了，根本无法阻止无脑的父ViewGroup拦截自己的事件？<br>当然不会这么搞啦~！真正的源码里，ViewGroup实现的dispatchTouchEvent里有这么一段代码用来决定是否真的拦截事件：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Check for interception.</span></span><br><span class="line">          <span class="keyword">final</span> <span class="keyword">boolean</span> intercepted;</span><br><span class="line">          <span class="keyword">if</span> (actionMasked == MotionEvent.ACTION_DOWN</span><br><span class="line">                  || mFirstTouchTarget != <span class="keyword">null</span>) &#123;</span><br><span class="line">              <span class="keyword">final</span> <span class="keyword">boolean</span> disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>;</span><br><span class="line">              <span class="keyword">if</span> (!disallowIntercept) &#123;</span><br><span class="line">                  intercepted = onInterceptTouchEvent(ev);</span><br><span class="line">                  ev.setAction(action); <span class="comment">// restore action in case it was changed</span></span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                  intercepted = <span class="keyword">false</span>;</span><br><span class="line">              &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="comment">// There are no touch targets and this action is not an initial down</span></span><br><span class="line">              <span class="comment">// so this view group continues to intercept touches.</span></span><br><span class="line">              intercepted = <span class="keyword">true</span>;</span><br><span class="line">          &#125;</span><br></pre></td></tr></table></figure></p>
<p>重点关注下这行代码</p>
<blockquote>
<p>   final boolean disallowIntercept = (mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != 0;</p>
</blockquote>
<p>这里可以注意到，会通过mGroupFlags里是否有FLAG_DISALLOW_INTERCEPT这个标志位来确定是否要拦截，那么这个标志位什么时候会被设置呢？<br>动动你们的小手指，alt+f7走起！查找它的引用很快看到：</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="function"><span class="keyword">void</span> <span class="title">requestDisallowInterceptTouchEvent</span><span class="params">(<span class="keyword">boolean</span> disallowIntercept)</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (disallowIntercept == ((mGroupFlags &amp; FLAG_DISALLOW_INTERCEPT) != <span class="number">0</span>)) &#123;</span><br><span class="line">            <span class="comment">// We're already in this state, assume our ancestors are too</span></span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (disallowIntercept) &#123;</span><br><span class="line">            mGroupFlags |= FLAG_DISALLOW_INTERCEPT;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            mGroupFlags &amp;= ~FLAG_DISALLOW_INTERCEPT;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Pass it up to our parent</span></span><br><span class="line">        <span class="keyword">if</span> (mParent != <span class="keyword">null</span>) &#123;</span><br><span class="line">            mParent.requestDisallowInterceptTouchEvent(disallowIntercept);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>没错，是他，是他，就是他！我们的女神<del>三上悠亚</del> <strong>requestDisallowInterceptTouchEvent</strong>！<br>通过这段代码我们可以知道，子View可以通过requestDisallowInterceptTouchEvent阻止父view拦截事件，从而也能做到某些场景下需要从父ViewGroup里抢事件过来实现功能，常见的就是容器嵌套（Viewpager+RecyclerView，Viewpager+scrollview等等）的滑动冲突问题解决。</p>
<p>好了，到了这里就关键了：<br>既然工程中用的Viewpager+RecyclerView的手势处理<strong>基本没有更改</strong>的前提下，为什么会存在滑动冲突解决不当的情况？还会有横屏有bug竖屏稳如狗的状况？<br><img src="https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5a4b7aa46f0b932c360e8822" alt=""></p>
<h1 id="关键节点断点调试"><a href="#关键节点断点调试" class="headerlink" title="关键节点断点调试"></a>关键节点断点调试</h1><p>首先看看作为子ViewGroup的RecyclerView为啥没有成功调用requestDisallowInterceptTouchEvent？<br>所以先看看作为父ViewGroup的Viewpager在onInterceptTouchEvent里做了什么：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">boolean</span> onInterceptTouchEvent(MotionEvent ev) &#123;</span><br><span class="line">       </span><br><span class="line"></span><br><span class="line">     ......</span><br><span class="line">       <span class="keyword">switch</span> (action) &#123;</span><br><span class="line">           <span class="keyword">case</span> MotionEvent.ACTION_MOVE: &#123;</span><br><span class="line">               <span class="comment">/*</span></span><br><span class="line"><span class="comment">                * mIsBeingDragged == false, otherwise the shortcut would have caught it. Check</span></span><br><span class="line"><span class="comment">                * whether the user has moved far enough from his original down touch.</span></span><br><span class="line"><span class="comment">                */</span></span><br><span class="line"></span><br><span class="line">               <span class="comment">/*</span></span><br><span class="line"><span class="comment">               * Locally do absolute value. mLastMotionY is set to the y value</span></span><br><span class="line"><span class="comment">               * of the down event.</span></span><br><span class="line"><span class="comment">               */</span></span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> activePointerId = mActivePointerId;</span><br><span class="line">               <span class="keyword">if</span> (activePointerId == INVALID_POINTER) &#123;</span><br><span class="line">                   <span class="comment">// If we don't have a valid id, the touch down wasn't on content.</span></span><br><span class="line">                   <span class="keyword">break</span>;</span><br><span class="line">               &#125;</span><br><span class="line"></span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">int</span> pointerIndex = ev.findPointerIndex(activePointerId);</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">float</span> x = ev.getX(pointerIndex);</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">float</span> dx = x - mLastMotionX;</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">float</span> xDiff = Math.<span class="keyword">abs</span>(dx);</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">float</span> y = ev.getY(pointerIndex);</span><br><span class="line">               <span class="keyword">final</span> <span class="keyword">float</span> yDiff = Math.<span class="keyword">abs</span>(y - mInitialMotionY);</span><br><span class="line">               <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Moved x to "</span> + x + <span class="string">","</span> + y + <span class="string">" diff="</span> + xDiff + <span class="string">","</span> + yDiff);</span><br><span class="line"></span><br><span class="line">               <span class="keyword">if</span> (dx != <span class="number">0</span> &amp;&amp; !isGutterDrag(mLastMotionX, dx)</span><br><span class="line">                       &amp;&amp; canScroll(<span class="keyword">this</span>, <span class="keyword">false</span>, (<span class="keyword">int</span>) dx, (<span class="keyword">int</span>) x, (<span class="keyword">int</span>) y)) &#123;</span><br><span class="line">                   <span class="comment">// Nested view has scrollable area under this point. Let it be handled there.</span></span><br><span class="line">                   mLastMotionX = x;</span><br><span class="line">                   mLastMotionY = y;</span><br><span class="line">                   mIsUnableToDrag = <span class="keyword">true</span>;</span><br><span class="line">                   <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (xDiff &gt; mTouchSlop &amp;&amp; xDiff * <span class="number">0.5</span>f &gt; yDiff) &#123;</span><br><span class="line">                   <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Starting drag!"</span>);</span><br><span class="line">                   mIsBeingDragged = <span class="keyword">true</span>;</span><br><span class="line">                   requestParentDisallowInterceptTouchEvent(<span class="keyword">true</span>);</span><br><span class="line">                   setScrollState(SCROLL_STATE_DRAGGING);</span><br><span class="line">                   mLastMotionX = dx &gt; <span class="number">0</span></span><br><span class="line">                           ? mInitialMotionX + mTouchSlop : mInitialMotionX - mTouchSlop;</span><br><span class="line">                   mLastMotionY = y;</span><br><span class="line">                   setScrollingCacheEnabled(<span class="keyword">true</span>);</span><br><span class="line">               &#125; <span class="keyword">else</span> <span class="keyword">if</span> (yDiff &gt; mTouchSlop) &#123;</span><br><span class="line">                   <span class="comment">// The finger has moved enough in the vertical</span></span><br><span class="line">                   <span class="comment">// direction to be counted as a drag...  abort</span></span><br><span class="line">                   <span class="comment">// any attempt to drag horizontally, to work correctly</span></span><br><span class="line">                   <span class="comment">// with children that have scrolling containers.</span></span><br><span class="line">                   <span class="keyword">if</span> (DEBUG) Log.v(TAG, <span class="string">"Starting unable to drag!"</span>);</span><br><span class="line">                   mIsUnableToDrag = <span class="keyword">true</span>;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">if</span> (mIsBeingDragged) &#123;</span><br><span class="line">                   <span class="comment">// Scroll to follow the motion event</span></span><br><span class="line">                   <span class="keyword">if</span> (performDrag(x)) &#123;</span><br><span class="line">                       ViewCompat.postInvalidateOnAnimation(<span class="keyword">this</span>);</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">break</span>;</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">        ······</span><br><span class="line">       <span class="keyword">return</span> mIsBeingDragged;</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>
<p>可以看到mIsBeingDragged作为是否要拦截事件的标志，而设置mIsBeingDragged的关键在于<br><figure class="highlight gcode"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> <span class="comment">(xDiff &gt; mTouchSlop &amp;&amp; xDiff * 0.5f &gt; yDiff)</span></span><br></pre></td></tr></table></figure></p>
<p>这个mTouchSlop是啥呢？就是系统能识别出被认为是滑动的最小距离，小于这个常量，系统不认为你在进行滑动。我们查找它的引用可以看到是由ViewConfigration设定的mPagingTouchSlop：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">*   </span>Viewpager.java</span></span></span><br><span class="line"><span class="comment"><span class="markdown">**/</span></span></span><br><span class="line">  <span class="keyword">final</span> ViewConfiguration configuration = ViewConfiguration.<span class="keyword">get</span>(context);</span><br><span class="line">  <span class="keyword">final</span> float density = context.getResources().getDisplayMetrics().density;</span><br><span class="line"></span><br><span class="line"><span class="comment">//注意这里取的是configuration里的PagingTouchSlop，也就是下面代码里的mPagingTouchSlop</span></span><br><span class="line">  mTouchSlop = configuration.getScaledPagingTouchSlop();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"><span class="markdown">/**</span></span></span><br><span class="line"><span class="comment"><span class="markdown"><span class="bullet">*  </span>ViewConfiguration.java</span></span></span><br><span class="line"><span class="comment"><span class="markdown">**/</span></span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"> mTouchSlop = res.getDimensionPixelSize(</span><br><span class="line">                com.android.internal.R.dimen.config_viewConfigurationTouchSlop);</span><br><span class="line"> mPagingTouchSlop = mTouchSlop * <span class="number">2</span>;</span><br></pre></td></tr></table></figure></p>
<p>跑到R.dimen.config_viewConfigurationTouchSlop来看看具体是什么值<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- Base "touch slop" value used by ViewConfiguration as a</span></span><br><span class="line"><span class="comment">       movement threshold where scrolling should begin. --&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">dimen</span> <span class="attr">name</span>=<span class="string">"config_viewConfigurationTouchSlop"</span>&gt;</span>8dp<span class="tag">&lt;/<span class="name">dimen</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>也就是说最小触摸距离为2*8=16dp呗, 在我的工程机（乐视X9000+，464ppi，也就是每平方厘米有190个像素）上就是56px。<br>那是不是这里的问题呢？带着一丝神奇的第六感，打断点看看：<br><img src="https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5a4b437c6f0b932c360e8462" alt=""></p>
<p><strong>卧槽，还真是，配合日志可以发现几乎每次滑动，尽管滑动幅度再小，都大于56px，这样的话必然导致Viewpager在onInterceptTouchEvent就拦截下来没有机会给子view接受触摸事件！</strong></p>
<p><img src="https://yunpan.oa.tencent.com/note/api/file/getImage?fileId=5a4b7b4d6f0b932c360e8823" alt=""></p>
<h1 id="根据异常信息假设"><a href="#根据异常信息假设" class="headerlink" title="根据异常信息假设"></a>根据异常信息假设</h1><p>也就是说，可以先做个假设，在横屏的滑动情况下由于某种原因，导致最小的滑动的距离都大于16dp，从而导致作为子View的RecyclerView没办法接受事件。<br>验证这种想法当然简单，反射修改最小滑动距离！随便搞个大的值看看</p>
<figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public VerticalViewpager(<span class="built_in">Context</span> <span class="built_in">context</span>) &#123;</span><br><span class="line"></span><br><span class="line">		this(<span class="built_in">context</span>, null)<span class="comment">;</span></span><br><span class="line">		init()<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public VerticalViewpager(<span class="built_in">Context</span> <span class="built_in">context</span>, AttributeSet attrs) &#123;</span><br><span class="line"></span><br><span class="line">		super(<span class="built_in">context</span>, attrs)<span class="comment">;</span></span><br><span class="line"></span><br><span class="line">		init()<span class="comment">;</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private void init() &#123;</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">		try &#123;</span><br><span class="line">			Field slopFiled = Viewpager.class.getDeclaredField(<span class="string">"mTouchSlop"</span>)<span class="comment">;</span></span><br><span class="line">			slopFiled.setAccessible(true)<span class="comment">;</span></span><br><span class="line">			slopFiled<span class="meta">.set</span>(this,<span class="number">200</span>)<span class="comment">;</span></span><br><span class="line">		&#125;catch (Exception e)&#123;</span><br><span class="line">			e.printStackTrace()<span class="comment">;</span></span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>编译运行！</p>
<p>淦！that’s it!<br><img src="https://timgsa.baidu.com/timg?image&amp;quality=80&amp;size=b9999_10000&amp;sec=1514957079331&amp;di=07f19205b5da8ae0b9a294dad20ab197&amp;imgtype=0&amp;src=http%3A%2F%2Fphotocdn.sohu.com%2F20160301%2Fmp61143404_1456776129029_2.gif" alt=""></p>
<h1 id="根据正确的假设找根因"><a href="#根据正确的假设找根因" class="headerlink" title="根据正确的假设找根因"></a>根据正确的假设找根因</h1><p>好了激动完了，该找找根因了。<br>这时候冷静下来想起之前说的一个小细节：</p>
<blockquote>
<p>既然工程中用的Viewpager+RecyclerView的手势处理<strong>基本没有更改</strong>的前提下，为什么会存在滑动冲突解决不当的情况？还会有横屏有bug竖屏稳如狗的状况？</p>
</blockquote>
<p>ok,是基本没有更改，但改了哪些呢？</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class VerticalViewpager  extends BaseViewpager &#123;</span><br><span class="line"></span><br><span class="line">	private static final String TAG ="VerticalViewpager" ;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">	public VerticalViewpager(Context context) &#123;</span><br><span class="line"></span><br><span class="line">		this(context, null);</span><br><span class="line">		<span class="attribute">init();</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	public VerticalViewpager(Context context, AttributeSet attrs) &#123;</span><br><span class="line"></span><br><span class="line">		super(context, attrs);</span><br><span class="line"></span><br><span class="line">		<span class="attribute">init();</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private void init() &#123;</span><br><span class="line">		// The majority of the magic happens here</span><br><span class="line">		setPageTransformer(true, new VerticalPageTransformer());</span><br><span class="line">		// The easiest way to get rid of the overscroll drawing that happens on the left and right</span><br><span class="line">		<span class="attribute">setOverScrollMode(OVER_SCROLL_NEVER);</span></span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	private class VerticalPageTransformer implements Viewpager.PageTransformer &#123;</span><br><span class="line"></span><br><span class="line">		@Override</span><br><span class="line">		public void transformPage(View view, float position) &#123;</span><br><span class="line"></span><br><span class="line">			if (position &lt; -1) &#123; // [-Infinity,-1)</span><br><span class="line">				// This page is way off-screen to the left.</span><br><span class="line">				<span class="attribute">view.setAlpha(0);</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">			&#125; else if (position &lt;= 1) &#123; // [-1,1]</span><br><span class="line">				<span class="attribute">view.setAlpha(1);</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">				// Counteract the default slide transition</span><br><span class="line">				view.setTranslationX(view.getWidth() * -position);</span><br><span class="line"></span><br><span class="line">				//set Y position to swipe in from top</span><br><span class="line">				float yPosition = position * view.getHeight();</span><br><span class="line">				<span class="attribute">view.setTranslationY(yPosition);</span></span><br><span class="line"><span class="attribute"></span></span><br><span class="line">			&#125; else &#123; // (1,+Infinity]</span><br><span class="line">				// This page is way off-screen to the right.</span><br><span class="line">				<span class="attribute">view.setAlpha(0);</span></span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	/**</span><br><span class="line">	 * Swaps the X and Y coordinates of your touch event.</span><br><span class="line">	 */</span><br><span class="line">	private MotionEvent swapXY(MotionEvent ev) &#123;</span><br><span class="line">		float width = getWidth();</span><br><span class="line">		float height = getHeight();</span><br><span class="line"></span><br><span class="line">		float newX = (ev.getY() / height) * width;</span><br><span class="line">		float newY = (ev.getX() / width) * height;</span><br><span class="line"></span><br><span class="line">		ev.setLocation(newX, newY);</span><br><span class="line"></span><br><span class="line">		return ev;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean onInterceptTouchEvent(MotionEvent ev)&#123;</span><br><span class="line">		boolean intercepted = super.onInterceptTouchEvent(swapXY(ev));</span><br><span class="line">		swapXY(ev); // return touch coordinates to original reference frame for any child views</span><br><span class="line">		return intercepted;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public boolean onTouchEvent(MotionEvent ev) &#123;</span><br><span class="line">		return super.onTouchEvent(swapXY(ev));</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先我把目光就落在了swapXY这个方法身上，如果不出bug的话一般也看不出啥毛病的，但第二次看来突然发觉哪有什么不对：</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Swaps the X and Y coordinates of your touch event.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	private MotionEvent swapXY(MotionEvent <span class="built_in">ev</span>) &#123;</span><br><span class="line">		<span class="built_in">float</span> <span class="built_in">width</span> = getWidth();</span><br><span class="line">		<span class="built_in">float</span> <span class="built_in">height</span> = getHeight();</span><br><span class="line"></span><br><span class="line">		<span class="built_in">float</span> newX = (<span class="built_in">ev</span>.getY() / <span class="built_in">height</span>) * <span class="built_in">width</span>;</span><br><span class="line">		<span class="built_in">float</span> newY = (<span class="built_in">ev</span>.getX() / <span class="built_in">width</span>) * <span class="built_in">height</span>;</span><br><span class="line"></span><br><span class="line">		<span class="built_in">ev</span>.setLocation(newX, newY);</span><br><span class="line"></span><br><span class="line">		<span class="built_in">return</span> <span class="built_in">ev</span>;</span><br><span class="line">	&#125;</span><br></pre></td></tr></table></figure>
<p>先简化成数学方式比较好描述：</p>
<p>$$记 初始坐标为(X_0,Y_0), 通过swap计算得到的坐标为(X_0^<code>,Y_0^</code>),\frac{width}{height}为r,用户触摸屏幕到另一个位置后的坐标为(X_1,Y_1),通过swap方法计算得到的坐标为$$<br>由此：<br>$$swap(X_0,Y_0) = (X_0^<code>,Y_0^</code>) = (Y_0<em>r,\frac{X_0}{r})$$<br>这时注意，VerticalViewpager在onInterceptTouchEvent和onTouchEvent都是调用的super方法，也就是说我们需要关注的是:<br>$$\nabla{X}=X_1^<code>-X_0^</code>=(Y_1-Y_0)</em>r$$<br>这样看就很清晰了，<strong>屏幕的长宽比会影响到差值，从而放大或者缩小差值造成误差</strong>！<br>具体到我们的用的乐视手机上，r=0.5625(竖屏，横屏为1.78）,最小滑动距离56px在竖屏下成了31.5px，横屏下成了99.68px（我神一般的金手指居然还能滑出60px也是厉害了），这就能解释为什么为啥竖屏下弹幕区域的滑动如丝流畅但横屏下已经成为bug了！</p>
<h1 id="写在最后"><a href="#写在最后" class="headerlink" title="写在最后"></a>写在最后</h1><p>OK，写到这已经把这个bug的祖坟都挖出来了，解决方案也可以出来了</p>
<ol>
<li>简单粗暴的在播放场景下用反射改变mTouchSlop</li>
<li>重写一遍VerticalViewpager，不要涉及到坐标的转换</li>
</ol>
<p>显然第一个方案十分粗暴，但第二个方案也是让人倒吸一口凉气，网上虽说也有不少代码，但经历过这一遭后，就算要用也得从头到尾过一遍了，搞不好又会写成另一个文章的历程。但是嘛，这才是保障代码质量的重要步骤，不能成天只当救火员啊！(๑•̀ㅂ•́)و✧</p>
<p>你们可能知道很久的小tips：<br>1.文中用到的数学公式是由MathJax提供，使用方便简洁，markdown里直接用清爽无比<br>2.云盘笔记里写的md笔记以及上传的图片，km上均可显示</p>

      
    </div>
    <footer class="article-footer">
      <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
      <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
        title: "http://Jhuan.coding.me/JHuan/2018/01/03/cjgc9hck300006csob4ju9oft/",
        url: "http://Jhuan.coding.me/JHuan/2018/01/03/cjgc9hck300006csob4ju9oft/"
        });
      </script>
      <br>
      <br>
      <br>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="hexo-真相" class="article article-type-hexo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/11/28/cjgc99x45000arhso481vz0pb/" class="article-date">
  <time datetime="2017-11-28T09:51:22.000Z" itemprop="datePublished">2017-11-28</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/11/28/cjgc99x45000arhso481vz0pb/">真相</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>每年总结这个习惯还是很难改的哈，每到年底总喜欢算算流水账，感慨下人生无常感恩下生命中遇到的人balala…倒也不是腻烦了输出鸡汤和讨厌矫情，但是今年所经历的事情流水账和矫情是无法描述了。已然接近而立之年，矫情和鸡汤只是逃避现实的手段了，知行合一、活在当下才是主旋律。但在此之前，还是很有必要定性下最近几年奠基的认知基础，对我来说才是第一步。虽说思考人生这种东西没有止境，但所谓的四十不惑在我看来只是懒得想了而已，但不能成为拖延的借口，该阐释该记录的，写下来再说。</p>
<p>首先还是想谈谈可以囊括整篇总结的精髓的大作：《黑客帝国》三部曲。</p>
<p>这部已经有十几年历史的电影就算是现在看来也是无比震撼的，其涵盖的哲学思维，人工智能设想，科幻场景渲染已经成为科幻电影的经典。我阅片确实很少，虽不能称其前无古人后无来者，但对于当时还是青春年少的我来说带来的震慑和影响是超过了那些经典的励志电影。其中最经典的一句话现在仍是思考问题时的黄金法则：</p>
<blockquote>
<p>什么叫真相？你怎样给真相下定义？如果你说真相就是你能感觉到的东西，你能闻到的气味，你能尝到的味道，那么这个真相就是你大脑作出反应的电子信号。</p>
</blockquote>
<p>由此开启了为期一年的思考：<strong>真相真的存在吗？</strong></p>
<p>直接给结论：<strong>不存在, 真相只是证伪成本极高的一个镜像</strong></p>
<p>非常引人入胜的话题，但就跟鸡与蛋的问题一样钻牛角尖并且深究起来毫无意义——除非相关紧要的利益，但就算如此也只能发现人类在命运之神面前的渺小和无奈，在黑客帝国里的展现更是让人窒息：上天遁地超人般的Neo，也只是创世神的一个棋子，用来一次次重启matrix;所谓争取到的自由的zion人民，其实早已被毁灭过数次。不说这些影响剧情的角色，只站在一个尚被matrix控制的普通人，在线头拔掉之前，他们所认为的世界的真相，会是已经被机器人控制的地底世界么？他们如果连他们的五感都不信还能信什么真相？</p>
<p>其实站在更高的角度来看，发现这个问题确实跟鸡与蛋的问题是一样的解决思路。<strong>真相固然存在，并且真相其实是无数个的</strong>。更高的角度在这的严格解释就是更高的维度，假如你能像《星际穿越》的Copper一样身处五维空间，开启上帝视角看着你错综复杂的时间线，就很明显的知道真相有很多分支，并不是柯南里说的“真相只有一个”。</p>
<p>哈哈，这个扯的有点太大，毕竟我们身处的只是三维空间而已，“真相只有一个”这种设定其实是可以成立的。五维空间的上帝可以帮我们作证（虽然我相信他老人家应该处于十维空间）。但对于我们个人来说，<strong>真相是否就是那个证伪成本太高的那条路径呢</strong>？从宇宙大爆炸假说，薄**事件到底你为啥没升职恋人为何离开你，都会有解释、证据、数据等强有力的证明来让你信服：这些就是真相。你要质疑，可以，找到更有力的证据把这些证据推翻，然后如此循环，越到后面取证越困难，所消耗的时间或者金钱已经不足于证伪，你还会怀疑吗？就算还会怀疑，你能做的只有怀疑了：毕竟你个人再也无法证伪了——除非你也来个愚公移山计划。这还是对于愿意打破砂锅的人，对于不愿深究的人呢？也就是持有所谓的“相信眼前所见为实“的人，对他们来说证伪成本需要高于”亲眼所见“是不是就无法接受了呢？</p>
<p>既然证伪成本随着深究的程度而无限提高，于是对于大多数的我们来说，获取真相的低成本途径就剩下了有限的两条：<br><strong>1.相信权威<br>2.相信大多数。</strong></p>
<p>够用了，既然不能保证绝对正确，找个大多数时候正确然后就算出错会有相当一堆人跟你一样错至少可以减少你的心里落差。但正如我们熟知的那样，真理往往掌握在少数人手中，群体心里学里著名的《乌合之众》也披露了大众智商其实是拉低个体智商的现象。所以也必须像我们熟知的那样，想要成功必须和别人不同，也就意味着很有可能需要站在权威、大众的对立面，无视不断提高的证伪成本，用尽全力推翻已经形成的”真相“，所要面对可不仅仅是舆论压力、精神压力、经济压力这么简单，要知道这是尝试颠覆一个既定的规则，创造一个证伪成本更高的路径的”真相“，自己成为权威让大多数人信服。当然啦，创造真相只是成功的一个必要条件而已，铺开来讲又涉及到阶层、宿命等各种复杂的话题，我是没精力折腾这个问题。</p>
<p>那对于我自己的今后，该怎么面对如何定义真相的问题？王阳明的心学是个很棒的指导思想，”天理即人欲“作为终极法则来解释这千奇百怪的世界再合适不过，不过和其他伟大的真理一样，只是摆出一句话的话只是个有用的废话而已，怎么理解这个体系呢？总不能又学他老人家格物致知对着竹子格半天吧？先不说现在互联网爆炸的信息量，光是心学这个体系都分出了好几派，哪个才是根正苗红的心学哪个才有用？如果说我不管，都过一遍，光是从纷纭复杂的想法中梳理总结已经异常困难，然后又要”知行合一“，剩下的寿命够么？</p>
<p>看起来非常纠结，这时候对于一个直男来说最有效的方法无疑是：玩个游戏吧。玩着玩着其实就发现了答案，整个思考过程繁琐低效和冗长无趣，就说说自己最终形成的一个方法论：<strong>建立起自己内心的沙盒世界</strong>。在此感谢和安利两部伟大的独立游戏：《史丹利的公寓》和《我的世界》。沙盒的概念可以简单概括为一个资源受限的封闭空间，所有对外界的信息交流和资源交换需要专门的渠道申请，早已广泛用于计算机安全和军事演练，实质是种安全机制。听起来挺像是要封闭自己的内心世界是吧？就是要封闭没错。但不是死锁内心世界的大门，不是闭关锁国，只是极大限制你<strong>核心思想世界</strong>对外界的直接接触，对接纳的信息建立足够严苛的审查机制。但同时也要给这个沙盒世界源源不断提供足够丰富的资源，才能很好的模拟外界的信息对核心思想世界的创造或者破坏，直到证伪成本足够高了才纳入自己的核心思想世界。</p>
<p>想了这么多写了这么多，核心思想世界这个概念还是很难解释的清楚，是一个理智的精神世界？是一种信仰和情绪缔造的圣地？或许根本就不需要解释，对于我而言更像是一个就算身处绝境还依旧稳固存在的世界，肉体的消亡和世人的遗忘与这个世界并无关系，是我存在、活着、呼吸的一个根源性动力，这才是我的世界存在唯一的真相。其余的真相只是五感获取的信息的一个个投射，本质上和我的世界并没有联系。</p>
<p>正如所有的总结一样，最终会落入到俗套的”懂得了很多人生大道理但依旧过不好这一生“的怪圈里。但意义这玩意儿，从来都是自己赋予的，whatever，该咋活就该咋活。</p>

      
    </div>
    <footer class="article-footer">
      <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
      <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
        title: "http://Jhuan.coding.me/JHuan/2017/11/28/cjgc99x45000arhso481vz0pb/",
        url: "http://Jhuan.coding.me/JHuan/2017/11/28/cjgc99x45000arhso481vz0pb/"
        });
      </script>
      <br>
      <br>
      <br>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="hexo-你用的那个Sort还是当初你认识的那个sort么？" class="article article-type-hexo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2017/08/03/cjgc9so7u0000c2souf4ork0o/" class="article-date">
  <time datetime="2017-08-03T12:51:12.000Z" itemprop="datePublished">2017-08-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2017/08/03/cjgc9so7u0000c2souf4ork0o/">你用的那个Sort还是当初你认识的那个sort么？</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h2 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h2><p>正值明日之子大直播火热之际，好不容易在一个周六可以在吃着法国蜗牛的我生平第一次收到了rdm的crash告警，每隔5分钟就发到微信上的那种，那种看到我小心肝不止的在颤抖的那种告警。<br>赶紧看看是什么crash突然在如此重要的直播里crash了，一眼看去居然是个从未见过的crash。还好堆栈明了可以马上知道是道具弹幕中排序 的锅，但这是个什么鬼？</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">java<span class="selector-class">.lang</span><span class="selector-class">.IllegalArgumentException</span>: Comparison method violates its general contract!</span><br><span class="line">java<span class="selector-class">.util</span><span class="selector-class">.ComparableTimSort</span><span class="selector-class">.mergeHi</span>(ComparableTimSort<span class="selector-class">.java</span>:<span class="number">848</span>)</span><br><span class="line">java<span class="selector-class">.util</span><span class="selector-class">.ComparableTimSort</span><span class="selector-class">.mergeAt</span>(ComparableTimSort<span class="selector-class">.java</span>:<span class="number">466</span>)</span><br><span class="line">java<span class="selector-class">.util</span><span class="selector-class">.ComparableTimSort</span><span class="selector-class">.mergeCollapse</span>(ComparableTimSort<span class="selector-class">.java</span>:<span class="number">389</span>)</span><br><span class="line">java<span class="selector-class">.util</span><span class="selector-class">.ComparableTimSort</span><span class="selector-class">.sort</span>(ComparableTimSort<span class="selector-class">.java</span>:<span class="number">178</span>)</span><br><span class="line">java<span class="selector-class">.util</span><span class="selector-class">.ComparableTimSort</span><span class="selector-class">.sort</span>(ComparableTimSort<span class="selector-class">.java</span>:<span class="number">142</span>)</span><br><span class="line">java<span class="selector-class">.util</span><span class="selector-class">.Arrays</span><span class="selector-class">.sort</span>(Arrays<span class="selector-class">.java</span>:<span class="number">1957</span>)</span><br><span class="line">java<span class="selector-class">.util</span><span class="selector-class">.Collections</span><span class="selector-class">.sort</span>(Collections<span class="selector-class">.java</span>:<span class="number">1877</span>)</span><br><span class="line">com<span class="selector-class">.tencent</span><span class="selector-class">.qqlivebroadcast</span><span class="selector-class">.business</span><span class="selector-class">.bulletscreen</span><span class="selector-class">.presenter</span><span class="selector-class">.GiftDanmakuPresenter</span><span class="selector-class">.void</span> onGetPushDanmaku(java<span class="selector-class">.util</span><span class="selector-class">.List</span>)(GiftDanmakuPresenter<span class="selector-class">.java</span>:<span class="number">150</span>)</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>赶紧问谷歌爸爸，初步结论是：<strong>由于jdk7和Android采用的是排序方法是TimSort，它对于元素之间等价关系的校验更为严格，如果违反了等价关系则有可能出发崩溃。</strong><br>看完居然是依旧懵逼的。</p>
<p>OK，咱们一个个来，复习基础知识，探究下为什么会有这样的问题呢？里面到底隐藏了什么大<del>咪咪</del>秘密？</p>
<h2 id="等价关系你还记得么？"><a href="#等价关系你还记得么？" class="headerlink" title="等价关系你还记得么？"></a>等价关系你还记得么？</h2><p>设R是集合A上的一个二元关系，若R满足：</p>
<ul>
<li><strong>自反性</strong>：∀a∈A,=&gt;(a,a)∈R</li>
<li><strong>对称性</strong>：(a,b)∈R∧a≠b=&gt;(b,a)∈R</li>
<li><strong>传递性</strong>：(a,b)∈R,(b,c)∈R=&gt;(a,c)∈R<br>则称R是定义在A上的一个等价关系。effective java中第三章。有对应的关于对象关于compareTo的建议规范讲到这个这三个属性</li>
</ul>
<h2 id="TimSort是个什么鬼？那个叫Tim的同学你放学后别走"><a href="#TimSort是个什么鬼？那个叫Tim的同学你放学后别走" class="headerlink" title="TimSort是个什么鬼？那个叫Tim的同学你放学后别走"></a>TimSort是个什么鬼？那个叫Tim的同学你放学后别走</h2><p>先来弄明白TimSort是什么排序先，由于摘自维基百科：</p>
<blockquote>
<p>Timsort是结合了合并排序（merge sort）和插入排序（insertion sort）而得出的排序算法，它在现实中有很好的效率。Tim Peters在2002年设计了该算法并在Python中使用（TimSort 是 python 中 list.sort 的默认实现）。该算法找到数据中已经排好序的块-分区，每一个分区叫一个run，然后按规则合并这些run。Pyhton自从2.3版以来一直采用Timsort算法排序，现在Java SE7和Android也采用Timsort算法对数组排序。</p>
</blockquote>
<p>核心思路过程：</p>
<blockquote>
<p>TimSort 算法为了减少对升序部分的回溯和对降序部分的性能倒退，将输入按其升序和降序特点进行了分区。排序的输入的单位不是一个个单独的数字，而是一个个的块-分区。其中每一个分区叫一个run。针对这些 run 序列，每次拿一个 run 出来按规则进行合并。每次合并会将两个 run合并成一个 run。合并的结果保存到栈中。合并直到消耗掉所有的 run，这时将栈上剩余的 run合并到只剩一个 run 为止。这时这个仅剩的 run 便是排好序的结果。<br>综上述过程，Timsort算法的过程包括<br>（0）如何数组长度小于某个值，直接用二分插入排序算法<br>（1）找到各个run，并入栈<br>（2）按规则合并run</p>
</blockquote>
<p>具体的算法实现过程感兴趣的同学可以直接阅读源码，也有相关的博客解读和分析这个挺复杂且其实有bug的算法。这里不做过多阐述因为实在是…有够繁琐的。<br>这里直接讲会触发这crash的校验代码:<br><figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (<span class="attr">len2</span> == <span class="number">1</span>) &#123;</span><br><span class="line">     <span class="keyword">if</span> (DEBUG) <span class="keyword">assert</span> len1 &gt; <span class="number">0</span>;</span><br><span class="line">     dest <span class="attr">-=</span> len1;</span><br><span class="line">     cursor1 <span class="attr">-=</span> len1;</span><br><span class="line">     System.arraycopy(a, cursor1 + <span class="number">1</span>, a, dest + <span class="number">1</span>, len1);</span><br><span class="line">     a[dest] = tmp[cursor2];  // Move first elt of run2 to front of merge</span><br><span class="line"> &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="attr">len2</span> == <span class="number">0</span>) &#123;</span><br><span class="line">     <span class="built_in">throw</span> new IllegalArgumentException(</span><br><span class="line">         <span class="string">"Comparison method violates its general contract!"</span>);</span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="keyword">if</span> (DEBUG) <span class="keyword">assert</span> <span class="attr">len1</span> == <span class="number">0</span>;</span><br><span class="line">     <span class="keyword">if</span> (DEBUG) <span class="keyword">assert</span> len2 &gt; <span class="number">0</span>;</span><br><span class="line">     System.arraycopy(tmp, <span class="number">0</span>, a, dest - (len2 - <span class="number">1</span>), len2);</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure></p>
<p>此举是在两个run归并之前做个的一个优化，假设已有两个有序的runA和runB，归并开始前会把其中一个run中需要合并的数据拷贝到tmp数组中（这里假设将runB中的部分数据拷入）。每次归并比较时会记录其中一个run和tmp段比较“胜利（大于对方）”的次数，为了得知runA是否平均大于runB，如果达到最大次数，会有一次tmp数据数据直接拷贝到runA中的操作，拷贝完并做一次上述代码的校验维护算法的正确性。</p>
<h2 id="为啥传统的归并排序没有这种问题？"><a href="#为啥传统的归并排序没有这种问题？" class="headerlink" title="为啥传统的归并排序没有这种问题？"></a>为啥传统的归并排序没有这种问题？</h2><p>最简单最单纯的归并排序过程：<br>    1、Divide: 把长度为n的输入序列分成两个长度为n/2的子序列。<br>    2、Conquer: 对这两个子序列分别采用归并排序。<br>    3、Combine: 将两个排序好的子序列合并成一个最终的排序序列。</p>
<p>盗个图说明下归并过程：<br><img src="http://km.oa.com/files/photos/pictures/201708/1501667820_89_w554_h542.jpeg" alt="归并排序过程"></p>
<p>可以看到，归并排序并不校验元素的等价关系，只是仅仅判断两个元素之间的大小就可以完成归并。</p>
<h2 id="直接原因？"><a href="#直接原因？" class="headerlink" title="直接原因？"></a>直接原因？</h2><h3 id="业务场景"><a href="#业务场景" class="headerlink" title="业务场景"></a>业务场景</h3><p>腾讯直播对于道具弹幕会有个排序需求（大土豪送的跑车游艇当然要优先展示啊~），目前来说需求就很简单，送的道具价值越大越靠前，由后台下的一个字段giftPriority来做排序关键字，让前端可以将获得的弹幕队列进行排序。</p>
<h3 id="排序实现过程"><a href="#排序实现过程" class="headerlink" title="排序实现过程"></a>排序实现过程</h3><p>由于历史原因，目前有两个通道下发道具弹幕信息，分别为push通道和轮询通道（简称poll通道)，分别实现为PushGiftDanmakuContent和GiftDanmakUContent,继承于BaseDanmakuContent。</p>
<p>于是要做排序，那就需要用支持弹幕的compare啦，直接上代码：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 普通弹幕内容类</span></span><br><span class="line"><span class="comment"> * Created by barryjiang on 2016/7/8.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="keyword">abstract</span> <span class="class"><span class="keyword">class</span> <span class="title">BaseDanmakuContent</span> <span class="title">implements</span> <span class="title">Comparable&lt;BaseDanmakuContent&gt;</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//弹幕类型</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">DanmakuContentType</span>    mCommentType;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//昵称</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">String</span> mSenderNickName = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//内容</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">String</span> mContent = <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//存入的时间</span></span><br><span class="line">    <span class="keyword">protected</span> long currentTime;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public int compareTo(<span class="meta">@NonNull</span> <span class="type">BaseDanmakuContent</span> another) &#123;</span><br><span class="line">        <span class="comment">//按时间排序，先存入的排在前面，FIFO</span></span><br><span class="line">        <span class="keyword">return</span> (int) (((<span class="type">BaseDanmakuContent</span>) another).currentTime - currentTime );</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * poll弹幕道具弹幕内容</span></span><br><span class="line"><span class="comment"> * Created by barryjiang on 2016/7/8.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">GiftDanmakuContent</span> <span class="keyword">extends</span> <span class="title">BaseDanmakuContent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">GiftInfo</span> giftInfo;</span><br><span class="line"></span><br><span class="line">    public <span class="type">GiftInfo</span> getGiftInfo() &#123;</span><br><span class="line">        <span class="keyword">return</span> giftInfo;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setGiftInfo(<span class="type">GiftInfo</span> giftInfo) &#123;</span><br><span class="line">        <span class="keyword">this</span>.giftInfo = giftInfo;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 通过push通道下发的弹幕内容</span></span><br><span class="line"><span class="comment"> * Created by barryjiang on 2017/4/13.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line">public <span class="class"><span class="keyword">class</span> <span class="title">PushGiftDanmakuContent</span> <span class="keyword">extends</span> <span class="title">BaseDanmakuContent</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//优先级，越高优先级越高，用于弹幕排序</span></span><br><span class="line">    <span class="keyword">private</span> int                     giftPriority = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    public int compareTo(<span class="meta">@NonNull</span> <span class="type">BaseDanmakuContent</span> another) &#123;</span><br><span class="line">        <span class="keyword">if</span>(another instanceof <span class="type">PushGiftDanmakuContent</span>)&#123;</span><br><span class="line">            <span class="type">PushGiftDanmakuContent</span> pushGiftDanmakuContent = (<span class="type">PushGiftDanmakuContent</span>) another;</span><br><span class="line"></span><br><span class="line">            <span class="comment">//先按priority排，最后按存入的时间排</span></span><br><span class="line">            <span class="keyword">if</span>(priority - pushGiftDanmakuContent.getGiftPriority() !=<span class="number">0</span> )&#123;</span><br><span class="line">                <span class="keyword">return</span> priority - pushGiftDanmakuContent.getGiftPriority();</span><br><span class="line">            &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="keyword">super</span>.compareTo(another);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">        &#125;<span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">super</span>.compareTo(another);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>相信聪明的读者已经看出了问题了，这样的实现违反了等价关系中的传递性。可以容易证明存在pushDanmakuA&gt;pushDanmakuB,pushDanmakuB&gt;PollDanmakuC,PollDanmakuC&gt;pushDanmakuA这样的异常。</p>
<p>而且测试没能复现也正是因为要触发TimSort的归并排序之前，如果元素数目没有达到最小归并数，则采用二分插入排序，一样不会校验等价关系。</p>
<h2 id="后话"><a href="#后话" class="headerlink" title="后话"></a>后话</h2><p>排序已经是非常古典的一个算法问题了，也没有想到后续的优化和创新有这么一个坑，但是说到底还是平时编程时的思维习惯不够好造成的。愿各位引以为戒。<br>水平有限，关于算法实现细节的解析可能有偏差也望各位指正。</p>
<h1 id="相关阅读："><a href="#相关阅读：" class="headerlink" title="相关阅读："></a>相关阅读：</h1><p><a href="http://blog.csdn.net/on_1y/article/details/30109975" target="_blank" rel="noopener">OpenJDK 源代码阅读之 TimSort</a><br><a href="http://www.freebuf.com/vuls/62129.html" target="_blank" rel="noopener">如何找出Timsort算法和玉兔月球车中的Bug？</a></p>

      
    </div>
    <footer class="article-footer">
      <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
      <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
        title: "http://Jhuan.coding.me/JHuan/2017/08/03/cjgc9so7u0000c2souf4ork0o/",
        url: "http://Jhuan.coding.me/JHuan/2017/08/03/cjgc9so7u0000c2souf4ork0o/"
        });
      </script>
      <br>
      <br>
      <br>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android/">Android</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="hexo-谈谈那个大圣的背影" class="article article-type-hexo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/05/24/cjgc99x46000drhso77o6dw2d/" class="article-date">
  <time datetime="2016-05-24T12:35:45.000Z" itemprop="datePublished">2016-05-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/05/24/cjgc99x46000drhso77o6dw2d/">谈谈那个大圣的背影</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&nbsp;&nbsp;&nbsp;&nbsp;对不起又要炒旧饭了，改不掉喜旧厌新的毛病没办法。</p>
<p><img src="/img/1.jpg" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;这时候拎出来讲这部电影我也不卖关子，还是要厚脸皮可耻的承认终于在25周岁来临之际终于迎来了第一次失恋，对，之前的青春是被狗吃了，对，之前的青春是屎。这个怎么吐槽倒也不在乎了，继续琢磨怎么过好日子和如何控制好烂成渣的情绪才是关键，在此之前，会有段漫长而傻逼的时期，认真看几部电影和书慢慢熬呗。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;讲起大话西游，已经是数不清的文艺青年评到烂了，凭我这种连电影爱好者都算不上的水平，自然是发掘不出什么更好的梗了，也不会将剧情讲成悬案，也懒得追究这部电影到底涉及到几个平行空间以及关于轮回的探讨。作为一个普通到庸俗的人，也是经历过第一次看哈哈大笑，第二次看沉默不语，第三次看泪流满面的庸俗过程。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;刚失恋时在发烧，烧了三天，根本没心情去治，难得可以让脑子休息一下不去思索太多关于现实的事，于是一遍又一遍的看，也略读了一下各种影评，矫情的也读，严肃的也读，然后继续躺在床上，一遍又一遍的看。严格来说，也就是看最后一个片段。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;对，就是这个片段。<br><img src="/img/2.jpg" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;据说这个剧本也是边拍边写的，被西影厂说成文化垃圾，当年的市场反应当然也不好，很小的时候就听过了，当时字都识不全整天盯着六小龄童哪瞧得起这个多毛症的孙悟空，应该都只是瞟了一眼，别提看到最后一幕。第二次看时也是大概感受下像条狗的悲哀，但在那个青春骚动喜欢无病呻吟的年华都没看上这个片段。也是不得不庸俗的承认有些事就是经历过才能感受，如果青春期的我看到我现在这个loser样会不会狠狠踹上一脚我不知道，如果他真能出现在我面前，我也只能对他说：兄弟，对不起，不是我想的。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;如果要评选结尾处理的最好的电影，大话西游在我的榜单上是可以排第二的（第一是七宗罪和禁闭岛齐名不用争），如果把这个结尾干掉或许大话西游也只是个简单的无厘头喜剧。虽然这部电影并不能做到一点也不浪费镜头（虽然我也没找到明显的浪费），但最后这一组大圣一句台词都没有的镜头，给了我们最大的想象空间和最多的感触。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;其实大圣不像狗的，夕阳武士那句话只是周星驰对自己落寞的过去说的。至尊宝承载了三个轮回的记忆，在变成大圣之前他卷入了一个他爱的女人和爱他的女人的伪三角恋事故中，有人说其实最牛逼的其实还是佛祖观音，安排这一次次转世，大圣再牛逼也是一个表演的马骝仔。他演的只是一个实实在在的人而已，不是神仙，不是妖怪，七情六欲爱恨情仇，他都有过。直到他戴上金箍向观音许诺放弃人世间所有恩怨时他相信会忘掉这一切，可惜并没有孟婆汤帮他真正忘却。他还是带上了紫霞仙子的手链，在紫霞死时暴怒，在最后一次转世中看到紫霞的转世对峙至尊宝的转世。</p>
<p><img src="/img/4.jpg" alt=""></p>
<p><img src="/img/5.jpg" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;他想，这时候我能做的无非就是让他们幸福了吧。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;所有回忆和感情就在这一吻和一句我爱你之后，大圣转身离开，留下了个落寞的背影。</p>
<p><img src="/img/6.jpg" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;夕阳武士当然是不知道这些的，像条狗或许是无意的玩笑或者讽刺，被偏爱的总有恃无恐嘛，只是紫霞的转世还有些许疑惑，她在哪见过这个背影？</p>
<p><img src="/img/7.jpg" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;大圣只是在走远了的时候，回头认真望了一眼。</p>
<p><img src="/img/8.jpg" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;然后再也没有回头，继续踏上漫长的西行之路</p>
<p><img src="/img/9.jpg" alt=""></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;人终有喜怒哀乐爱恨情仇，年少时我们能无视所谓的现实敢爱敢恨，成人时畏惧失去而缄口只谈利弊。我想这就是只有少数人才能成功的原因之一吧，现实和理想的差距不仅仅是算计的能力的差距，也需要感性的直觉来推动。光是感性和理性的平衡一般人都很难做到了，何况其他更为艰难的坎？出于对死与失去的畏惧，我们安于平庸且为苟活，对于失去的恋情说没关系天涯无处何芳草，嘲笑那些为一些屁事就牺牲的人，尊严值几毛钱？然后继续像条狗一样头也不回继续西行之路，偶尔也会回头怀念一下过去，继而继续嘲笑自己的愚蠢念头，告诉自己要理性。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;这世上有很多很多的大道理，几乎都有它的反面论证，反正都是人说出来的，被人推翻不是啥稀奇事。反正人都要归为尘土，叨逼这些道理也是给自己化成尘土一个解释，活的越久解释越充实越经得起别人推敲进而成为别人的模范，获取到归为尘土后也没法享有的荣耀。我并不反感这些大道理，追求自己想要的生活和意义很伟大，我只是反感恶意的欺骗和“为你好”来实现自己的目的，人活这一遭已经很不容易，少一点套路，多一点真诚岂不乐哉，为何还要互相伤害？为何需要证明你的道理比我好？为何要用我的痛苦换取你的幸福？还痛心疾首的说是“为我好”？有必要吗？</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;有些事终究可能没有答案，或许也不需要知道，所以就他妈的继续往前走吧，相信他妈的时间会冲淡一切，继续像蝼蚁般苟活吧。</p>

      
    </div>
    <footer class="article-footer">
      <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
      <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
        title: "http://Jhuan.coding.me/JHuan/2016/05/24/cjgc99x46000drhso77o6dw2d/",
        url: "http://Jhuan.coding.me/JHuan/2016/05/24/cjgc99x46000drhso77o6dw2d/"
        });
      </script>
      <br>
      <br>
      <br>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/电影人生/">电影人生</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="hexo-晦涩的成人寓言——斯坦利的寓言" class="article article-type-hexo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/04/cjgc99x410006rhso6fs8sb4l/" class="article-date">
  <time datetime="2016-02-04T09:51:22.000Z" itemprop="datePublished">2016-02-04</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/04/cjgc99x410006rhso6fs8sb4l/">晦涩的成人寓言——斯坦利的寓言</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&nbsp;&nbsp;&nbsp;&nbsp;玩惯了主流的PC游戏，都是清一色的打打杀杀，连连连跑跑跑，有时是会很厌倦的，相信这也是大多数即将步入而立之年的人不怎么再爱玩游戏的一个原因，更多处于无聊在手机上玩点休闲的游戏去消磨时光，更糟糕的是最有购买力的大龄青年们越来越不愿意去动脑玩游戏，所谓的手游黄金时期就是给无脑休闲手游带起来的。当然可以振振有词的说沉迷游戏可不好多花点时间在工作学习上收获更多，那么，接下来介绍的这款游戏或许可以让你重新思考一下游戏到底是什么。</p>
<p><img src="http://i0.hdslb.com/u_user/889cd17bd17f6a6a800da7c7b9fbe50d.jpg" alt="游戏封面截图"></p>
<blockquote>
<p>最早作为《半条命2》模组诞生的《史丹利的寓言（Stanley Parable）》是一部特殊的作品，与其说他是游戏，不如说更像是一部晦涩难懂的意识流电影。即便在独立游戏越来越笔走偏锋的今天，它也奇怪得令人费解。有人说它是关于自由意志的嘲讽；有人说它是关于设计工作的无厘头解读；还有人说它是卡夫卡笔下的官僚主义噩梦。但只有一点是肯定的，不是所有的玩家都会爱上《史丹利的寓言》，如果你身边的十个朋友个个都说他们喜欢，其中有一两个人跟风说谎的可能性相当的高。</p>
</blockquote>
<p>&nbsp;&nbsp;&nbsp;&nbsp;知道这部作品时是敖厂长在视频里玩的，对于敖厂长那种逗逼型解说对这部作品明显是不恰当的，这是我还没开始玩的时候就有的结论，这并不是部轻松的游戏。从这部宣传片你可以看个大概：</p>
<p><a href="http://v.youku.com/v_show/id_XNjIzMzkwOTQ0.html" target="_blank" rel="noopener">http://v.youku.com/v_show/id_XNjIzMzkwOTQ0.html</a></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;当时是冲着游戏简介去的，我对沙盒和多结局的游戏疯狂的热爱，非常喜欢那种探索一遍又一遍之后还能有新发现的感觉，大概也是受我看书的习惯影响所致。当我刚进去游戏的第一感觉就是：</p>
<p><strong>新奇而压抑</strong></p>
<p><img src="http://img1.tgbusdata.cn/thumbnail/jpg/YjAxNyw2MDAsNjAwLDQsMSwxLC0xLDEsMSxyazUw/u/pc.tgbus.com/uploads/allimg/131119/265-131119154144.jpg" alt="史坦利"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;大公司的小职员，每天做着单调重复的工作，面无表情或者呆滞，突然有一天出意外了就不知所措…<br>这强烈的代入感居然是旁白兄给的，不得不说非常专业。</p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;然后碰到我的第一个选择：</p>
<p><img src="http://img1.gamersky.com/image2014/01/20140121zym_2/gamersky_01small_02_201412113086C.jpg" alt="史坦利的第一个选择"></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;左边代表顺从,右边代表逆反。<br>&nbsp;&nbsp;&nbsp;&nbsp;未知的情况，空无一人的大楼，一个莫名奇妙的旁白，信还是不信？<br>&nbsp;&nbsp;&nbsp;&nbsp;于是所有结局和剧情都在此展开，在此期间，史丹利可能跳楼身亡，可能陷入永远走不出的死循环然后暴毙在街上，可能义无反顾的选择自己可预见残酷的结局。当然史丹利也可以一直相信旁白君，配合着他完成一次完美的结局，一次自由意志取得完全大胜利的结局，但即便如此，游戏还是会重启，一次又一次。在此期间，你或许收到赞扬和夸奖，更多的是讽刺与打击，旁白君可能是你的朋友，也可能是过路人而已。史丹利可以做出很多选择，试图改变自己的命运，确实他一次又一次获得了不同的结局，美好的平庸的凄惨的，但故事还是回到起点，一次又一次，每次都回到他那狭窄的办公室里，等着指令按按钮，然后被迫站起身来，去探索不同的结局。<br>&nbsp;&nbsp;&nbsp;&nbsp;真是对自由意志彻头彻尾的讽刺啊。我们所认为重要的或许到最后还是要回到起点，我们所坚持的选择或许根本摆脱不了困境，我们做出的选择，其实可能到头来根本没有意义。<br>&nbsp;&nbsp;&nbsp;&nbsp;这部游戏本身想告诉我们的寓意根本就是不明了的，活脱脱就是去暴力版的大卫林奇作品，混沌而不真实，却能让玩家一遍又一遍去玩，去思索那背后可能连导演都没想好的含义。也出现了各路大神级玩家，其中有一个结局需要你按四个小时的按钮，结果还真有人做了：<a href="http://www.bilibili.com/video/av1242222/" target="_blank" rel="noopener">《史丹利的寓言》如果你玩婴儿游戏4小时</a></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;具体的游戏评测游民有一篇文章将的也很到位：<br><a href="http://www.gamersky.com/review/201401/327504.shtml" target="_blank" rel="noopener">《史丹利的寓言（Stanley Parable）》游民星空点评8.2分 艰涩的成人童话</a></p>
<p>&nbsp;&nbsp;&nbsp;&nbsp;对于我来说，这部游戏可以带来的是一遍一遍的思考，审视当前的人生轨迹，作为一个史坦利，我还能在故事做什么？我知道自己最后的结局，但也会和史坦利一样，不断去探索，作茧自缚实在太没意思了。</p>

      
    </div>
    <footer class="article-footer">
      <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
      <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
        title: "http://Jhuan.coding.me/JHuan/2016/02/04/cjgc99x410006rhso6fs8sb4l/",
        url: "http://Jhuan.coding.me/JHuan/2016/02/04/cjgc99x410006rhso6fs8sb4l/"
        });
      </script>
      <br>
      <br>
      <br>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/游戏/">游戏</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="hexo-高效展示你的Bitmap（上）" class="article article-type-hexo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/02/03/cjgc99x430009rhsov0yzstyf/" class="article-date">
  <time datetime="2016-02-03T08:02:33.000Z" itemprop="datePublished">2016-02-03</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/02/03/cjgc99x430009rhsov0yzstyf/">【Android training】高效展示你的Bitmap（上）</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>参考文献：<br><a href="http://developer.android.com/training/displaying-bitmaps/index.html" target="_blank" rel="noopener">Android Training : Displaying Bitmaps Efficiently</a></p>
<p>前言:Bitmap无疑是内存大户之一，稍不谨慎，虚拟机抛出个OOM（OutofMemoryError）会让你很抓狂。OOM的定位和调试是个头痛的问题，会有专门的章节讲解这一问题，在此之前，要使用正确的体位来把玩我们的bitmap！ o(￣ε￣*)</p>
<h2 id="高效加载大图"><a href="#高效加载大图" class="headerlink" title="高效加载大图"></a>高效加载大图</h2><p>现实中，咱们的安卓设备可能会接触到各种形状和大小不同的图片。在一些情况中图片大小大于咱们的手机屏幕，而且在大多数情况下我们不需要这么大的图片展示给用户看，那么就很有必要采取必要的措施来避免直接加载这么大的图片。</p>
<h3 id="读取图片尺寸和类型"><a href="#读取图片尺寸和类型" class="headerlink" title="读取图片尺寸和类型"></a>读取图片尺寸和类型</h3><p><a href="http://developer.android.com/reference/android/graphics/BitmapFactory.html" target="_blank" rel="noopener">BitmapFactory</a> 类提供了一系列解析bitmap的方法 (decodeByteArray(), decodeFile(), decodeResource(), etc.)。这些方法是非常容易导致OOM的！你可以通过BitmapFactory.Options来改变加载选项，设置inJustDecodeBounds 选项为true 可以有效避免解析bitmap时的内存分配，来达到只读取图片信息而不是为了显示图片，阔以避免不必要的内存分配！</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">BitmapFactory.<span class="keyword">Options</span> <span class="keyword">options</span> = <span class="keyword">new</span> BitmapFactory.<span class="keyword">Options</span>();</span><br><span class="line"><span class="keyword">options</span>.inJustDecodeBounds = <span class="keyword">true</span>;</span><br><span class="line">BitmapFactory.decodeResource(getResources(), R.id.myimage, <span class="keyword">options</span>);</span><br><span class="line"><span class="keyword">int</span> imageHeight = <span class="keyword">options</span>.outHeight;</span><br><span class="line"><span class="keyword">int</span> imageWidth = <span class="keyword">options</span>.outWidth;</span><br><span class="line">String imageType = <span class="keyword">options</span>.outMimeType;</span><br></pre></td></tr></table></figure>
<h3 id="加载个适配当前需求大小的图片到内存中去吧"><a href="#加载个适配当前需求大小的图片到内存中去吧" class="headerlink" title="加载个适配当前需求大小的图片到内存中去吧"></a>加载个适配当前需求大小的图片到内存中去吧</h3><p>好，通过上一步知道了图片的尺寸，我们开始可以决定加载一个怎样的图片了，是原图就可以？还是要做个压缩后的图片（原文是subsampled version卧槽好专业）？别急，先来考虑下以下因素：</p>
<ul>
<li>估算下原图加载所需分配的内存大小</li>
<li>应用内适合分多少内存给这张图片</li>
<li>目标view的尺寸</li>
<li>屏幕尺寸和屏幕密度</li>
</ul>
<p>如果仔细评估过还是加载个压缩后的图片比较好，那可以通过BitmapFactory.Options的inSampleSize可以设置采样率，以下是个栗子：<br><figure class="highlight processing"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="built_in">int</span> calculateInSampleSize(</span><br><span class="line">            BitmapFactory.Options options, <span class="built_in">int</span> reqWidth, <span class="built_in">int</span> reqHeight) &#123;</span><br><span class="line">    <span class="comment">// Raw height and width of image</span></span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> <span class="built_in">height</span> = options.outHeight;</span><br><span class="line">    <span class="keyword">final</span> <span class="built_in">int</span> <span class="built_in">width</span> = options.outWidth;</span><br><span class="line">    <span class="built_in">int</span> inSampleSize = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">height</span> &gt; reqHeight || <span class="built_in">width</span> &gt; reqWidth) &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">final</span> <span class="built_in">int</span> halfHeight = <span class="built_in">height</span> / <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">final</span> <span class="built_in">int</span> halfWidth = <span class="built_in">width</span> / <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Calculate the largest inSampleSize value that is a power of 2 and keeps both</span></span><br><span class="line">        <span class="comment">// height and width larger than the requested height and width.</span></span><br><span class="line">        <span class="keyword">while</span> ((halfHeight / inSampleSize) &gt; reqHeight</span><br><span class="line">                &amp;&amp; (halfWidth / inSampleSize) &gt; reqWidth) &#123;</span><br><span class="line">            inSampleSize *= <span class="number">2</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> inSampleSize;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<blockquote>
<p>注意：采用2的n次幂是因为解码器会用一个向下取整2的n次幂的常量值，<a href="http://developer.android.com/reference/android/graphics/BitmapFactory.Options.html#inSampleSize" target="_blank" rel="noopener">inSampleSize</a>相关文档解释了这一点。</p>
</blockquote>
<h2 id="在非UI线程里处理bitmap"><a href="#在非UI线程里处理bitmap" class="headerlink" title="在非UI线程里处理bitmap"></a>在非UI线程里处理bitmap</h2><p>很显然，在UI线程里处理bitmap可是会被老板骂的╮(╯▽╰)╭，读取图片、图像处理涉及到磁盘访问以及图像处理算法复杂度，这些都是耗时操作，一不小心就引起ANR的哦~so，来看看使用什么体位解决这个问题！</p>
<h3 id="用AsyncTask吧！"><a href="#用AsyncTask吧！" class="headerlink" title="用AsyncTask吧！"></a>用AsyncTask吧！</h3><p><a href="http://developer.android.com/reference/android/os/AsyncTask.html" target="_blank" rel="noopener">AsyncTask</a>为开发者提供了处理后台耗时操作很便利的解决方案，以下就是个栗子：<br><figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapWorkerTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask&lt;Integer</span>, <span class="title">Void</span>, <span class="title">Bitmap&gt;</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">WeakReference</span>&lt;<span class="type">ImageView</span>&gt; imageViewReference;</span><br><span class="line">    <span class="keyword">private</span> int data = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    public <span class="type">BitmapWorkerTask</span>(<span class="type">ImageView</span> imageView) &#123;</span><br><span class="line">        <span class="comment">// Use a WeakReference to ensure the ImageView can be garbage collected</span></span><br><span class="line">        imageViewReference = <span class="keyword">new</span> <span class="type">WeakReference</span>&lt;<span class="type">ImageView</span>&gt;(imageView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Decode image in background.</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> <span class="type">Bitmap</span> doInBackground(<span class="type">Integer</span>... params) &#123;</span><br><span class="line">        data = params[<span class="number">0</span>];</span><br><span class="line">        <span class="keyword">return</span> decodeSampledBitmapFromResource(getResources(), data, <span class="number">100</span>, <span class="number">100</span>));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Once complete, see if ImageView is still around and set bitmap.</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void onPostExecute(<span class="type">Bitmap</span> bitmap) &#123;</span><br><span class="line">        <span class="keyword">if</span> (imageViewReference != <span class="literal">null</span> &amp;&amp; bitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ImageView</span> imageView = imageViewReference.get();</span><br><span class="line">            <span class="keyword">if</span> (imageView != <span class="literal">null</span>) &#123;</span><br><span class="line">                imageView.setImageBitmap(bitmap);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<p>对ImageView的弱引用可以保证AsyncTask不会阻挠ImageView的垃圾回收（不然就有可能内存泄露啦），由于不能保证后台任务完成时ImageView还在，所以在onPostExecute时要检查ImageView还在不。启动这个异步任务灰常简单，只要以下代码：<br><figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> loadBitmap(<span class="keyword">int</span> resId, ImageView imageView) &#123;</span><br><span class="line">    BitmapWorkerTask <span class="keyword">task</span> = <span class="keyword">new</span> BitmapWorkerTask(imageView);</span><br><span class="line">    <span class="keyword">task</span>.execute(resId);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h3 id="处理同步问题"><a href="#处理同步问题" class="headerlink" title="处理同步问题"></a>处理同步问题</h3><p>但是，一些常见的View（譬如ListView）就这么用AsyncTask会有一系列的问题。ListView在滚动时，为了节省内存，会回收掉子View的内存。so，如果你没想太多，ListView的每一个Item直接上AsyncTask加载图片，可能导致A   子View加载图片的时候用户滚动ListView，A   子View被回收了并且其被回收的内存恰好分配给了B子View，同时加载图片异步任务还在继续，正要显示时所持有的内存引用恰好指向了B 子View，那么B子View就会错位显示A子View该显示的图片啦。更糟糕的是异步任务可是没办法保证按顺序显示图片的。</p>
<p>还好有一篇博客<a href="http://android-developers.blogspot.com/2010/07/multithreading-for-performance.html" target="_blank" rel="noopener"> Multithreading for Performance </a>提出了解决方案，该类继承自Drawbale类，存放一个指向BitmapWorkerTask的弱引用，当异步任务完成时图像就会显示。</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">static <span class="class"><span class="keyword">class</span> <span class="title">AsyncDrawable</span> <span class="keyword">extends</span> <span class="title">BitmapDrawable</span> </span>&#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">WeakReference</span>&lt;<span class="type">BitmapWorkerTask</span>&gt; bitmapWorkerTaskReference;</span><br><span class="line"></span><br><span class="line">    public <span class="type">AsyncDrawable</span>(<span class="type">Resources</span> res, <span class="type">Bitmap</span> bitmap,</span><br><span class="line">            <span class="type">BitmapWorkerTask</span> bitmapWorkerTask) &#123;</span><br><span class="line">        <span class="keyword">super</span>(res, bitmap);</span><br><span class="line">        bitmapWorkerTaskReference =</span><br><span class="line">            <span class="keyword">new</span> <span class="type">WeakReference</span>&lt;<span class="type">BitmapWorkerTask</span>&gt;(bitmapWorkerTask);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public <span class="type">BitmapWorkerTask</span> getBitmapWorkerTask() &#123;</span><br><span class="line">        <span class="keyword">return</span> bitmapWorkerTaskReference.get();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们可以用这种姿势调用：</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> loadBitmap(<span class="keyword">int</span> resId, ImageView imageView) &#123;</span><br><span class="line">    <span class="keyword">if</span> (cancelPotentialWork(resId, imageView)) &#123;</span><br><span class="line">        <span class="keyword">final</span> BitmapWorkerTask <span class="keyword">task</span> = <span class="keyword">new</span> BitmapWorkerTask(imageView);</span><br><span class="line">        <span class="keyword">final</span> AsyncDrawable asyncDrawable =</span><br><span class="line">                <span class="keyword">new</span> AsyncDrawable(getResources(), mPlaceHolderBitmap, <span class="keyword">task</span>);</span><br><span class="line">        imageView.setImageDrawable(asyncDrawable);</span><br><span class="line">        <span class="keyword">task</span>.execute(resId);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这个cancelPotentialWork方法主要检查这个imageView是否已经和一个已经在执行的异步任务绑定了，如果是的话，会尝试取消这个任务</p>
<figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="function"><span class="keyword">boolean</span> <span class="title">cancelPotentialWork</span><span class="params">(<span class="keyword">int</span> data, ImageView imageView)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">final</span> BitmapWorkerTask bitmapWorkerTask = getBitmapWorkerTask(imageView);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (bitmapWorkerTask != <span class="keyword">null</span>) &#123;</span><br><span class="line">        <span class="keyword">final</span> <span class="keyword">int</span> bitmapData = bitmapWorkerTask.data;</span><br><span class="line">        <span class="comment">// If bitmapData is not yet set or it differs from the new data</span></span><br><span class="line">        <span class="keyword">if</span> (bitmapData == <span class="number">0</span> || bitmapData != data) &#123;</span><br><span class="line">            <span class="comment">// Cancel previous task</span></span><br><span class="line">            bitmapWorkerTask.cancel(<span class="keyword">true</span>);</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// The same work is already in progress</span></span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// No task associated with the ImageView, or an existing task was cancelled</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">true</span>;</span><br><span class="line">    </span><br><span class="line">   </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span> <span class="keyword">static</span> <span class="function">BitmapWorkerTask <span class="title">getBitmapWorkerTask</span><span class="params">(ImageView imageView)</span> </span>&#123;</span><br><span class="line">   <span class="keyword">if</span> (imageView != <span class="keyword">null</span>) &#123;</span><br><span class="line">       <span class="keyword">final</span> Drawable drawable = imageView.getDrawable();</span><br><span class="line">       <span class="keyword">if</span> (drawable <span class="keyword">instanceof</span> AsyncDrawable) &#123;</span><br><span class="line">           <span class="keyword">final</span> AsyncDrawable asyncDrawable = (AsyncDrawable) drawable;</span><br><span class="line">           <span class="function"><span class="keyword">return</span> asyncDrawable.<span class="title">getBitmapWorkerTask</span><span class="params">()</span></span>;</span><br><span class="line">       &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后一步就是更新BitmapWorkerTask 里的onPostExecute()，加上任务是否取消以及当前任务是否匹配当前ImageView：</p>
<figure class="highlight scala"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">BitmapWorkerTask</span> <span class="keyword">extends</span> <span class="title">AsyncTask&lt;Integer</span>, <span class="title">Void</span>, <span class="title">Bitmap&gt;</span> </span>&#123;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void onPostExecute(<span class="type">Bitmap</span> bitmap) &#123;</span><br><span class="line">        <span class="keyword">if</span> (isCancelled()) &#123;</span><br><span class="line">            bitmap = <span class="literal">null</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (imageViewReference != <span class="literal">null</span> &amp;&amp; bitmap != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">final</span> <span class="type">ImageView</span> imageView = imageViewReference.get();</span><br><span class="line">            <span class="keyword">final</span> <span class="type">BitmapWorkerTask</span> bitmapWorkerTask =</span><br><span class="line">                    getBitmapWorkerTask(imageView);</span><br><span class="line">            <span class="keyword">if</span> (<span class="keyword">this</span> == bitmapWorkerTask &amp;&amp; imageView != <span class="literal">null</span>) &#123;</span><br><span class="line">                imageView.setImageBitmap(bitmap);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>以上所说的解决方案适用于ListView,GridView等会回收子View的组件。只需简单的调用loadBitmap，就可以放心的加载图片啦！</p>

      
    </div>
    <footer class="article-footer">
      <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
      <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
        title: "http://Jhuan.coding.me/JHuan/2016/02/03/cjgc99x430009rhsov0yzstyf/",
        url: "http://Jhuan.coding.me/JHuan/2016/02/03/cjgc99x430009rhsov0yzstyf/"
        });
      </script>
      <br>
      <br>
      <br>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-training-翻译/">Android training 翻译</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="hexo-序" class="article article-type-hexo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/12/24/cjgc99x400005rhsonzcisujf/" class="article-date">
  <time datetime="2015-12-24T11:53:22.000Z" itemprop="datePublished">2015-12-24</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/12/24/cjgc99x400005rhsonzcisujf/">序</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;记得当时刚在豆瓣开通账号时也写了个序，希望自己能保持记录的习惯，保持思考的习惯，但很遗憾，停了好长的一段时间没有动笔，或者干脆写了一半便再也写不下去，那心血来潮的文字便成了个doc放在硬盘里长眠。<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这年头哪里还缺文章，哪里还缺秀自己的感悟，哪里还稀罕微不足道的普通人的一点微不足道的感触。就算是花了大量时间好不容易写出一篇自我感觉还不错的文章，网上随便一找就可以完虐，所有的成就感灰飞烟灭。<br>然而正如寒门难出贵子一样，难并不等于绝对不可能，况且写作的含义并不仅仅限于一种给别人有用的分享或者给自己的无懈可击的总结，它是一段时光的证明，是记录生活一种无法取代的方式。尽管我有了相机之后回去用图片记录，有了朋友圈之后可以碎片化记录，但始终没有用写作去记录更有质感和真实感，它已成为我不可或缺的一种生活方式。尽管再忙，尽管很难坚持每天都写，尽管很难保证高质量的分享，但不应该成为不写作的借口<br>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;所以再起一个序，用自己的博客来写，更有动力和追求。愿自己在后续的道路上，勿忘初心，做好一个普通人应该做的事，做好自己喜欢的事。</p>

      
    </div>
    <footer class="article-footer">
      <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
      <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
        title: "http://Jhuan.coding.me/JHuan/2015/12/24/cjgc99x400005rhsonzcisujf/",
        url: "http://Jhuan.coding.me/JHuan/2015/12/24/cjgc99x400005rhsonzcisujf/"
        });
      </script>
      <br>
      <br>
      <br>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/感悟/">感悟</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="hexo-【Android training】允许其他应用拉起你的应用" class="article article-type-hexo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/11/05/cjgc99x3s0002rhsoz44vehea/" class="article-date">
  <time datetime="2015-11-05T12:30:22.000Z" itemprop="datePublished">2015-11-05</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/11/05/cjgc99x3s0002rhsoz44vehea/">【Android training】引导到另一个APP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>原文地址：<a href="http://developer.android.com/training/basics/intents/filters.html" target="_blank" rel="noopener">Allowing Other Apps to Start Your Activity</a></p>
<p>为了让别的应用能拉起你的应用，你需要在你的AndroidMainfest.xml中对应的<code>&lt;activity&gt;</code>组件里添加<code>&lt;intent-filter&gt;</code>。<br>当你的应用安装在设备时，系统会识别你的intent filter然后添加到内置的目录里。当APP使用隐式Intent调用startActivity()或者startActivityForResult（）时，系统会找到哪些应用能接收这个Intent。</p>
<h2 id="添加一个Intent-Filter"><a href="#添加一个Intent-Filter" class="headerlink" title="添加一个Intent Filter"></a>添加一个Intent Filter</h2><p>为了合适地定义你的应用中的Activity所能处理的Intent,每个添加的Intent Filter都需要尽可能地具体。<br>一个标准的Intent包含以下元素：</p>
<h3 id="Action"><a href="#Action" class="headerlink" title="Action"></a>Action</h3><p>将要执行的动作名称，规定在你的<code>&lt;action&gt;</code>标签中</p>
<h3 id="Data"><a href="#Data" class="headerlink" title="Data"></a>Data</h3><p>描述所需传递的数据，规定在你的<code>&lt;data&gt;</code>标签中。可以用多个属性规定这个元素，比如说MIME类型，uri前缀，uri scheme，或者是这些属性的组合或者重复。</p>
<h3 id="Category"><a href="#Category" class="headerlink" title="Category"></a>Category</h3><p>提供一种附加的方法来标识activity如何处理这个Intent，通常和用户的手势位置从哪儿开始有关。系统支持多种不同的分类，但是大部分很少用的到。<strong>但是，所有隐式Intent默认被定义成CATEGORY_DEFAULT</strong></p>
<p>举个栗子，这是一个能接收ACTION_SEND动作，文字或者图像作为数据的Activity：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">activity</span> <span class="attr">android:name</span>=<span class="string">"ShareActivity"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">"android.intent.action.SEND"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">category</span> <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">"text/plain"</span>/&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">"image/*"</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>每个Intent只能确定一个Action和一种data类型，但<code>&lt;intent-filter&gt;</code>可以含有多个<code>&lt;action&gt;</code>, <code>&lt;category&gt;</code>, 和 <code>&lt;data&gt;</code>。</p>
<blockquote>
<p>注意：为了能接收隐式Intent，你必须将CATEGORY_DEFAULT这个category加入intent filter中。因为隐式Intent默认分类就是CATEGORY_DEFAULT</p>
</blockquote>
<h2 id="在你的Activity中处理传递过来的Intent"><a href="#在你的Activity中处理传递过来的Intent" class="headerlink" title="在你的Activity中处理传递过来的Intent"></a>在你的Activity中处理传递过来的Intent</h2><p>为了决定你的Activity如何处理不同的Action，你可以从Intent中获取到Action进行处理。<br>当你的Activity启动时，可以调用getIntent（）获取到启动Activity的Intent。<br>举个栗子：<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">protected</span> <span class="function"><span class="keyword">void</span> <span class="title">onCreate</span><span class="params">(Bundle savedInstanceState)</span> </span>&#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState);</span><br><span class="line"></span><br><span class="line">    setContentView(R.layout.main);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Get the intent that started this activity</span></span><br><span class="line">    Intent intent = getIntent();</span><br><span class="line">    Uri data = intent.getData();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Figure out what to do based on the intent type</span></span><br><span class="line">    <span class="keyword">if</span> (intent.getType().indexOf(<span class="string">"image/"</span>) != <span class="number">-1</span>) &#123;</span><br><span class="line">        <span class="comment">// Handle intents with image data ...</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (intent.getType().equals(<span class="string">"text/plain"</span>)) &#123;</span><br><span class="line">        <span class="comment">// Handle intents with text ...</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="返回一个结果"><a href="#返回一个结果" class="headerlink" title="返回一个结果"></a>返回一个结果</h2><p>如果你想将执行结果返回给拉起你的Actvity，只要简单的调用setResult（），指定返回码和Intent。当操作结束需要返回到原来的Activity时，需要调用finish()结束你的Activity。<br>举个栗子：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// <span class="keyword">Create</span> intent <span class="keyword">to</span> deliver <span class="keyword">some</span> kind <span class="keyword">of</span> <span class="keyword">result</span> <span class="keyword">data</span></span><br><span class="line">Intent <span class="keyword">result</span> = <span class="keyword">new</span> Intent(<span class="string">"com.example.RESULT_ACTION"</span>, Uri.parse(<span class="string">"content://result_uri"</span>);</span><br><span class="line">setResult(Activity.RESULT_OK, result);</span><br><span class="line">finish()</span><br></pre></td></tr></table></figure></p>
<p>你必须指定一个返回码。通常都是RESULT_OK 或者 RESULT_CANCELED。你还可以用Intent带上额外的数据。</p>
<blockquote>
<p>注意：返回结果默认返回码是RESULT_CANCELED，因此，如果用户在完成动作且你设置返回结果之前按下返回键，原来的Acitvity会接受到“cancel”的结果</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
      <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
        title: "http://Jhuan.coding.me/JHuan/2015/11/05/cjgc99x3s0002rhsoz44vehea/",
        url: "http://Jhuan.coding.me/JHuan/2015/11/05/cjgc99x3s0002rhsoz44vehea/"
        });
      </script>
      <br>
      <br>
      <br>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-training-翻译/">Android training 翻译</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="hexo-【Android training】文件共享" class="article article-type-hexo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/30/cjgc99x3o0001rhsow2y6mztv/" class="article-date">
  <time datetime="2015-10-30T12:12:22.000Z" itemprop="datePublished">2015-10-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/30/cjgc99x3o0001rhsow2y6mztv/">【Android training】文件共享</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>原文地址：<a href="http://developer.android.com/training/secure-file-sharing/index.html" target="_blank" rel="noopener">Sharing Files</a>.</p>
<p>为了能安全的将一个文件提供给另一个APP，你需要配置好你的APP，给文件提供一个安全的句柄。Android 组件 <a href="http://developer.android.com/reference/android/support/v4/content/FileProvider.html" target="_blank" rel="noopener">FileProvider</a> 基于XML配置，为文件生成内容URI。</p>
<blockquote>
<p> Tips: <a href="http://developer.android.com/reference/android/support/v4/content/FileProvider.html" target="_blank" rel="noopener">FileProvider</a> 已经作为 <a href="http://developer.android.com/tools/support-library/features.html#v4" target="_blank" rel="noopener">v4 Support Library</a>的一部分了哟~</p>
</blockquote>
<h2 id="声明一个FileProvider"><a href="#声明一个FileProvider" class="headerlink" title="声明一个FileProvider"></a>声明一个FileProvider</h2><p>定义一个FileProvider需要在你的mainfest中添加一个入口。这个入口声明了生成内容URI的authorities以及XML文件的名字。这个XML文件确定了你的APP能分享的目录。<br>以下是个栗子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span></span></span><br><span class="line"><span class="tag">    <span class="attr">package</span>=<span class="string">"com.example.myapp"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span></span></span><br><span class="line"><span class="tag">        <span class="attr">...</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">"android.support.v4.content.FileProvider"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:authorities</span>=<span class="string">"com.example.myapp.fileprovider"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:grantUriPermissions</span>=<span class="string">"true"</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">"false"</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:name</span>=<span class="string">"android.support.FILE_PROVIDER_PATHS"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:resource</span>=<span class="string">"@xml/filepaths"</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在这个栗子中，<a href="http://developer.android.com/guide/topics/manifest/provider-element.html#auth" target="_blank" rel="noopener">android:authorities</a>属性规定了URL所属的authorities,用于FileProvider生成content uri。meta-data 子元素指向了你想分享出去的XML文件，android:resource指定这个文件的路径和名称（并不包括.xml后缀名哟）</p>
<h2 id="指定要分享的目录"><a href="#指定要分享的目录" class="headerlink" title="指定要分享的目录"></a>指定要分享的目录</h2><p>当你把FileProvider加入到你的app的Mainfest中后，你需要指定你所要分享的文件所属目录。需要在你的项目目录下 res/xml/创建filepaths.xml 。在这个文件中通过增加XML元素表示你的目录。以下又是一颗栗子：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">paths</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">files-path</span> <span class="attr">path</span>=<span class="string">"images/"</span> <span class="attr">name</span>=<span class="string">"myimages"</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<p>在这个栗子中，files-path 标签共享了你的应用内部存储里的files/. path属性表明分享files/目录下的子目录images/。name属性让FileFileProvider在生成的content URI加上由name指定的路径分隔符。详情可以看看<a href="http://developer.android.com/reference/android/support/v4/content/FileProvider.html" target="_blank" rel="noopener">FileProvider</a> 为何可以这么做。<br><code>&lt;paths&gt;</code>元素可以有多个子元素，确定多个需要共享的文件夹。除了<code>&lt;files-path&gt;</code>标签之外，还可以用<code>&lt;external-path&gt;</code>元素共享外部存储文件夹，并且还可以用<code>&lt;cache-path&gt;</code>分享内部存储的缓存文件夹。</p>
<blockquote>
<p>注意： 只能用XML文件的形式来制定你要分享到文件夹，你不能通过java代码的形式动态加一个文件夹</p>
</blockquote>
<p>现在呢，你就有一个完整的FileProvider，它能帮你生成你应用内部存储中的files/目录及其子目录下文件的content URI。<br>再举个栗子，如果你按照上面的代码片段定义了一个FileProvider，然后你请求一个default_image.jpg的URI，FileProvider就会返回如下URI：<br><code>content://com.example.myapp.fileprovider/myimages/default_image.jpg</code></p>
<h2 id="接收文件分享请求"><a href="#接收文件分享请求" class="headerlink" title="接收文件分享请求"></a>接收文件分享请求</h2><p>为了能接收请求方APP的文件请求并响应对应的文件content uri，你应该提供一个文件选择Activity。这样的话请求方APP可以通过startActivityForResult启动这个Activity，传递一个带ACTION_PICK的action的Intent，该Activity接收并处理完毕要嗝屁时，就可以通过setResult反馈uri。</p>
<h2 id="创建一个文件选择的Activity"><a href="#创建一个文件选择的Activity" class="headerlink" title="创建一个文件选择的Activity"></a>创建一个文件选择的Activity</h2><p>直接上代码说明：<br><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span> <span class="attr">xmlns:android</span>=<span class="string">"http://schemas.android.com/apk/res/android"</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">        <span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">            <span class="tag">&lt;<span class="name">activity</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:name</span>=<span class="string">".FileSelectActivity"</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:label</span>=<span class="string">"@"</span><span class="attr">File</span> <span class="attr">Selector</span>" &gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">action</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">android:name</span>=<span class="string">"android.intent.action.PICK"</span>/&gt;</span></span><br><span class="line">                        //指定OPENABLE和DEFAULT两种类型</span><br><span class="line">                    <span class="tag">&lt;<span class="name">category</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">android:name</span>=<span class="string">"android.intent.category.DEFAULT"</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">category</span></span></span><br><span class="line"><span class="tag">                        <span class="attr">android:name</span>=<span class="string">"android.intent.category.OPENABLE"</span>/&gt;</span></span><br><span class="line">                        //通过mimeType制定所需数据类型</span><br><span class="line">                    <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">"text/plain"</span>/&gt;</span></span><br><span class="line">                    <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:mimeType</span>=<span class="string">"image/*"</span>/&gt;</span></span><br><span class="line">                <span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">activity</span>&gt;</span></span><br></pre></td></tr></table></figure></p>
<h2 id="访问分享的文件"><a href="#访问分享的文件" class="headerlink" title="访问分享的文件"></a>访问分享的文件</h2><p>接收方APP会用Intent向请求方发送共享文件的uri，这个Intent将会被传递到请求方的onActivityResult()里。当请求方拿到了文件的cotent uri, 可以通过<a href="http://developer.android.com/reference/java/io/FileDescriptor.html" target="_blank" rel="noopener">FileDescriptor</a>访问共享文件。<br>在这个过程中，文件访问安全性是得到保证滴。由于content uri不包含目录路径，请求方不能获取到接收方其他的文件。<br>以下是个栗子~<br><figure class="highlight aspectj"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">   * When the Activity of the app that hosts files sets a result and calls</span></span><br><span class="line"><span class="comment">   * finish(), this method is invoked. The returned Intent contains the</span></span><br><span class="line"><span class="comment">   * content URI of a selected file. The result code indicates if the</span></span><br><span class="line"><span class="comment">   * selection worked or not.</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> onActivityResult(<span class="keyword">int</span> requestCode, <span class="keyword">int</span> resultCode,</span><br><span class="line">          Intent returnIntent) &#123;</span><br><span class="line">      <span class="comment">// If the selection didn't work</span></span><br><span class="line">      <span class="keyword">if</span> (resultCode != RESULT_OK) &#123;</span><br><span class="line">          <span class="comment">// Exit without doing anything else</span></span><br><span class="line">          <span class="keyword">return</span>;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="comment">// Get the file's content URI from the incoming Intent</span></span><br><span class="line">          Uri returnUri = returnIntent.getData();</span><br><span class="line">          <span class="comment">/*</span></span><br><span class="line"><span class="comment">           * Try to open the file for "read" access using the</span></span><br><span class="line"><span class="comment">           * returned URI. If the file isn't found, write to the</span></span><br><span class="line"><span class="comment">           * error log and return.</span></span><br><span class="line"><span class="comment">           */</span></span><br><span class="line">          <span class="keyword">try</span> &#123;</span><br><span class="line">              <span class="comment">/*</span></span><br><span class="line"><span class="comment">               * Get the content resolver instance for this context, and use it</span></span><br><span class="line"><span class="comment">               * to get a ParcelFileDescriptor for the file.</span></span><br><span class="line"><span class="comment">               */</span></span><br><span class="line">              mInputPFD = getContentResolver().openFileDescriptor(returnUri, <span class="string">"r"</span>);</span><br><span class="line">          &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">              e.printStackTrace();</span><br><span class="line">              Log.e(<span class="string">"MainActivity"</span>, <span class="string">"File not found."</span>);</span><br><span class="line">              <span class="keyword">return</span>;</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="comment">// Get a regular file descriptor for the file</span></span><br><span class="line">          FileDescriptor fd = mInputPFD.getFileDescriptor();</span><br><span class="line">          ...</span><br><span class="line">      &#125;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure></p>
<h2 id="获取共享文件的MIME格式"><a href="#获取共享文件的MIME格式" class="headerlink" title="获取共享文件的MIME格式"></a>获取共享文件的MIME格式</h2><p>一个文件的数据格式可以表示请求方APP该如何处理该文件内容。我们可以通过调用ContentResolver.getType()来获取共享文件的数据类型，这个方法反馈该文件的MIME类型。<strong>FileProvider默认用文件的后缀名来判断文件所属数据类型</strong>。<br>以下是个栗子：<br><figure class="highlight vbnet"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">/*</span><br><span class="line"> * <span class="keyword">Get</span> the file<span class="comment">'s content URI from the incoming Intent, then</span></span><br><span class="line"> * <span class="keyword">get</span> the file<span class="comment">'s MIME type</span></span><br><span class="line"> */</span><br><span class="line">Uri returnUri = returnIntent.getData();</span><br><span class="line"><span class="built_in">String</span> mimeType = getContentResolver().<span class="built_in">getType</span>(returnUri);</span><br></pre></td></tr></table></figure></p>
<h2 id="获取共享文件的名字和大小"><a href="#获取共享文件的名字和大小" class="headerlink" title="获取共享文件的名字和大小"></a>获取共享文件的名字和大小</h2><p>FileProvider 有着query() 接口的默认实现，返回一个带着文件大小和名字的Curosr。默认返回两列：</p>
<ul>
<li>DISPLAY_NAME<br>  文件名，返回值与File.getName()相同</li>
<li>SIZE<br>文件大小，返回值和File.length()相同</li>
</ul>
<p>以下就是个获取的栗子：</p>
<figure class="highlight nix"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Get the file's content URI from the incoming Intent,</span></span><br><span class="line"><span class="comment">    * then query the server app to get the file's display name</span></span><br><span class="line"><span class="comment">    * and size.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   Uri <span class="attr">returnUri</span> = returnIntent.getData();</span><br><span class="line">   Cursor <span class="attr">returnCursor</span> =</span><br><span class="line">           getContentResolver().query(returnUri, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>, <span class="literal">null</span>);</span><br><span class="line">   <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Get the column indexes of the data in the Cursor,</span></span><br><span class="line"><span class="comment">    * move to the first row in the Cursor, get the data,</span></span><br><span class="line"><span class="comment">    * and display it.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">   int <span class="attr">nameIndex</span> = returnCursor.getColumnIndex(OpenableColumns.DISPLAY_NAME);</span><br><span class="line">   int <span class="attr">sizeIndex</span> = returnCursor.getColumnIndex(OpenableColumns.SIZE);</span><br><span class="line">   returnCursor.moveToFirst();</span><br><span class="line">   TextView <span class="attr">nameView</span> = (TextView) findViewById(R.id.filename_text);</span><br><span class="line">   TextView <span class="attr">sizeView</span> = (TextView) findViewById(R.id.filesize_text);</span><br><span class="line">   nameView.setText(returnCursor.getString(nameIndex));</span><br><span class="line">   sizeView.setText(Long.<span class="built_in">toString</span>(returnCursor.getLong(sizeIndex)));</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
      <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
        title: "http://Jhuan.coding.me/JHuan/2015/10/30/cjgc99x3o0001rhsow2y6mztv/",
        url: "http://Jhuan.coding.me/JHuan/2015/10/30/cjgc99x3o0001rhsow2y6mztv/"
        });
      </script>
      <br>
      <br>
      <br>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-training-翻译/">Android training 翻译</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="hexo-【Android training】引导到另一个APP" class="article article-type-hexo" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2015/10/30/cjgc99x3y0004rhso398c3fgn/" class="article-date">
  <time datetime="2015-10-30T12:12:22.000Z" itemprop="datePublished">2015-10-30</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2015/10/30/cjgc99x3y0004rhso398c3fgn/">【Android training】引导到另一个APP</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Android最重要的一个特性就是可以通过action引导到其他APP里去了。比如说你想在你的APP中将一些地址显示在地图上，你无需专门搞个activity显示地图，你可以用带有地址信息的Intent发起请求，Android系统就会拉起一个APP去做到这点。</p>
<h2 id="用隐式Intent"><a href="#用隐式Intent" class="headerlink" title="用隐式Intent"></a>用隐式Intent</h2><p>隐式Intent无需你指定具体的Class，把指定的action(比如view, edit, send, or get)，再把数据带上就欧啦。</p>
<p>以下是一些例子：<br><figure class="highlight dart"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//打电话</span></span><br><span class="line"><span class="built_in">Uri</span> number = <span class="built_in">Uri</span>.parse(<span class="string">"tel:5551234"</span>);</span><br><span class="line">Intent callIntent = <span class="keyword">new</span> Intent(Intent.ACTION_DIAL, number);</span><br><span class="line"><span class="comment">//用地图</span></span><br><span class="line"><span class="built_in">Uri</span> location = <span class="built_in">Uri</span>.parse(<span class="string">"geo:0,0?q=1600+Amphitheatre+Parkway,+Mountain+View,+California"</span>);</span><br><span class="line"><span class="built_in">Uri</span> location = <span class="built_in">Uri</span>.parse(<span class="string">"geo:37.422219,-122.08364?z=14"</span>); </span><br><span class="line">Intent mapIntent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW, location);</span><br><span class="line"><span class="comment">//浏览网页</span></span><br><span class="line"><span class="built_in">Uri</span> webpage = <span class="built_in">Uri</span>.parse(<span class="string">"http://www.android.com"</span>);</span><br><span class="line">Intent webIntent = <span class="keyword">new</span> Intent(Intent.ACTION_VIEW, webpage);</span><br></pre></td></tr></table></figure></p>
<h2 id="看看有没应用可以接受俺们的Intent"><a href="#看看有没应用可以接受俺们的Intent" class="headerlink" title="看看有没应用可以接受俺们的Intent"></a>看看有没应用可以接受俺们的Intent</h2><p>尽管Android系统保证肯定有个内置应用（比如电话，电邮，日历等）会接受俺们的Intent,但你始终应该在使用这个Intent之前要确认下。</p>
<blockquote>
<p>注意：如果你作死使用了一个根本没有应用能接受的Intent，你的APP会Crash的！(ノಠ益ಠ)ノ彡┻━┻</p>
</blockquote>
<p>调用queryIntentActivities()就可以获得能接受你的Intent的应用列表，如果返回的不是空列表你就能安心使用这个Intent啦，(^o^)/YES!<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">PackageManager packageManager</span> = getPackageManager();</span><br><span class="line"><span class="attribute">List activities</span> = packageManager.queryIntentActivities(intent,</span><br><span class="line">        PackageManager.MATCH_DEFAULT_ONLY);</span><br><span class="line"><span class="attribute">boolean isIntentSafe</span> = activities.size() &gt; 0;</span><br></pre></td></tr></table></figure></p>
<p>如果isIntent是true，那就至少有一个应用能接受你的Intent啦</p>
<p>##用你的Intent拉起一个Activity</p>
<p>当你创建好Intent塞进了数据之后，便可以调用startActivity了。如果系统识别到有多个APP可以处理你的Intent,系统会展示一个对话框供用户选择哪个APP打开，如果只有一个APP能处理你的Intent，那就会立刻被打开。</p>
<p><img src="http://developer.android.com/images/training/basics/intents-choice.png" alt="pic 1" title="pic1:供你选择拉起的APP对话框长这样~"></p>
<p>以下是个完整的例子，演示如何创建一个可以拉起地图应用的intent，然后退出应用拉起地图：</p>
<figure class="highlight pony"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// Build the intent</span></span><br><span class="line"><span class="type">Uri</span> location = <span class="type">Uri</span>.parse(<span class="string">"geo:0,0?q=1600+Amphitheatre+Parkway,+Mountain+View,+California"</span>);</span><br><span class="line"><span class="type">Intent</span> mapIntent = <span class="function"><span class="keyword">new</span> <span class="title">Intent</span>(<span class="type">Intent</span>.<span class="type">ACTION_VIEW</span>, location);</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// Verify it resolves</span></span></span><br><span class="line"><span class="function"><span class="title">PackageManager</span> <span class="title">packageManager</span> = <span class="title">getPackageManager</span>();</span></span><br><span class="line"><span class="function"><span class="title">List</span>&lt;<span class="title">ResolveInfo</span>&gt; <span class="title">activities</span> = <span class="title">packageManager</span>.<span class="title">queryIntentActivities</span>(mapIntent, <span class="number">0</span>);</span></span><br><span class="line"><span class="function"><span class="title">boolean</span> <span class="title">isIntentSafe</span> = <span class="title">activities</span>.<span class="title">size</span>() &gt; 0;</span></span><br><span class="line"><span class="function"></span></span><br><span class="line"><span class="function"><span class="comment">// Start an activity if it's safe</span></span></span><br><span class="line"><span class="function"><span class="title">if</span> (isIntentSafe) &#123;</span></span><br><span class="line"><span class="function">    <span class="title">startActivity</span>(mapIntent);</span></span><br><span class="line"><span class="function">&#125;</span></span><br></pre></td></tr></table></figure>
<p><img src="http://developer.android.com/images/training/basics/intent-chooser.png" alt="pic 2"></p>
<h2 id="显示一个应用选择对话框"><a href="#显示一个应用选择对话框" class="headerlink" title="显示一个应用选择对话框"></a>显示一个应用选择对话框</h2><p>可以注意得到当你使用startActivity（）将你的Intent传递到另一个app并且不止一个app可以接收你的Intent时，用户可以通过一个应用选择对话框来决定使用哪个应用，并且能够选择哪个应用作为默认打开方式。如果场景是浏览网页或者拍照那还是个不错的选择。</p>
<p>但是，有些场景可能用户更需要每次都使用不同的app作为打开方式，比如说“分享”。这时你应该强制显示应用选择对话框让用户每次打开时选择使用哪个APP。</p>
<figure class="highlight gauss"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Intent intent = <span class="keyword">new</span> Intent(Intent.ACTION_SEND);</span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">// Always use string resources for UI text.</span></span><br><span class="line"><span class="comment">// This says something like "Share this photo with"</span></span><br><span class="line"><span class="keyword">String</span> <span class="built_in">title</span> = getResources().getString(R.<span class="keyword">string</span>.chooser_title);</span><br><span class="line"><span class="comment">// Create intent to show chooser</span></span><br><span class="line">Intent chooser = Intent.createChooser(intent, <span class="built_in">title</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// Verify the intent will resolve to at least one activity</span></span><br><span class="line"><span class="keyword">if</span> (intent.resolveActivity(getPackageManager()) != <span class="built_in">null</span>) &#123;</span><br><span class="line">    startActivity(chooser);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
      <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
        title: "http://Jhuan.coding.me/JHuan/2015/10/30/cjgc99x3y0004rhso398c3fgn/",
        url: "http://Jhuan.coding.me/JHuan/2015/10/30/cjgc99x3y0004rhso398c3fgn/"
        });
      </script>
      <br>
      <br>
      <br>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/Android-training-翻译/">Android training 翻译</a></li></ul>

    </footer>
  </div>
  
</article>


  
  
    <nav id="page-nav">
      <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><a class="extend next" rel="next" href="/page/2/">Next &raquo;</a>
    </nav>
  
</section>
        
          <aside id="sidebar">
  
    
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android/">Android</a><span class="tag-list-count">3</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Android-training-翻译/">Android training 翻译</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/感悟/">感悟</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/游戏/">游戏</a><span class="tag-list-count">1</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/电影人生/">电影人生</a><span class="tag-list-count">1</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Android/" style="font-size: 15px;">Android</a> <a href="/tags/Android-training-翻译/" style="font-size: 20px;">Android training 翻译</a> <a href="/tags/感悟/" style="font-size: 10px;">感悟</a> <a href="/tags/游戏/" style="font-size: 10px;">游戏</a> <a href="/tags/电影人生/" style="font-size: 10px;">电影人生</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2018/01/">一月 2018</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/11/">十一月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2017/08/">八月 2017</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">五月 2016</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">二月 2016</a><span class="archive-list-count">2</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">十二月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">十一月 2015</a><span class="archive-list-count">1</span></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">十月 2015</a><span class="archive-list-count">3</span></li></ul>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2018/01/03/cjgc9hck300006csob4ju9oft/">挖VerticalViewPager+RecyclerView滑动冲突的祖坟！</a>
          </li>
        
          <li>
            <a href="/2017/11/28/cjgc99x45000arhso481vz0pb/">真相</a>
          </li>
        
          <li>
            <a href="/2017/08/03/cjgc9so7u0000c2souf4ork0o/">你用的那个Sort还是当初你认识的那个sort么？</a>
          </li>
        
          <li>
            <a href="/2016/05/24/cjgc99x46000drhso77o6dw2d/">谈谈那个大圣的背影</a>
          </li>
        
          <li>
            <a href="/2016/02/04/cjgc99x410006rhso6fs8sb4l/">晦涩的成人寓言——斯坦利的寓言</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2018 barryjiang<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
     <div class="share">
	<div class="bshare-custom">
	<div class="bsPromo bsPromo2"></div>
	<a title="分享到" href="http://www.bShare.cn/" id="bshare-shareto" class="bshare-more">分享到</a>
	<a title="分享到微信" class="bshare-weixin" href="javascript:void(0);"></a>
	<a title="分享到豆瓣" class="bshare-douban" href="javascript:void(0);"></a>
	<a title="分享到QQ好友" class="bshare-qqim" href="javascript:void(0);"></a>
	<a title="分享到新浪微博" class="bshare-sinaminiblog" href="javascript:void(0);"></a><a title="更多平台" class="bshare-more bshare-more-icon more-style-addthis"></a>
	<span class="BSHARE_COUNT bshare-share-count" style="float: none;">43K</span>
	</div>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/buttonLite.js#style=-1&amp;uuid=&amp;pophcol=2&amp;lang=zh"></script>
	<script type="text/javascript" charset="utf-8" src="http://static.bshare.cn/b/bshareC0.js"></script>
</div>
       <script type="text/javascript" charset="utf-8">
        bShare.addEntry({
          url: "http://jhuan.gitcafe.io",
          title: "Just a Blog"
        });
      </script>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>